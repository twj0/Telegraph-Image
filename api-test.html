<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API 测试页面</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #007aff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .result {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
    </style>
</head>
<body>
    <h1>Telegraph API 测试页面</h1>
    
    <div class="test-section">
        <h2>文件列表 API 测试</h2>
        <button class="test-button" onclick="testListAPI()">测试 /api/manage/list</button>
        <div id="listResult" class="result" style="display: none;"></div>
    </div>

    <div class="test-section">
        <h2>基础信息测试</h2>
        <button class="test-button" onclick="testBasicInfo()">测试基础信息</button>
        <div id="basicResult" class="result" style="display: none;"></div>
    </div>

    <div class="test-section">
        <h2>网络连接测试</h2>
        <button class="test-button" onclick="testNetwork()">测试网络连接</button>
        <div id="networkResult" class="result" style="display: none;"></div>
    </div>

    <div class="test-section">
        <h2>CORS 测试</h2>
        <button class="test-button" onclick="testCORS()">测试 CORS 设置</button>
        <div id="corsResult" class="result" style="display: none;"></div>
    </div>

    <script>
        async function testListAPI() {
            const resultDiv = document.getElementById('listResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.textContent = '正在测试...';

            try {
                console.log('开始测试 /api/manage/list API...');
                
                const response = await fetch('/api/manage/list', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });

                console.log('响应状态:', response.status, response.statusText);
                console.log('响应头:', [...response.headers.entries()]);

                const responseText = await response.text();
                console.log('响应内容:', responseText);

                let result = `状态码: ${response.status} ${response.statusText}\n`;
                result += `内容类型: ${response.headers.get('content-type')}\n`;
                result += `响应长度: ${responseText.length} 字符\n\n`;
                result += `响应内容:\n${responseText}`;

                if (response.ok) {
                    try {
                        const data = JSON.parse(responseText);
                        result += `\n\nJSON 解析成功!\n`;
                        result += `数据类型: ${typeof data}\n`;
                        result += `是否为数组: ${Array.isArray(data)}\n`;
                        if (Array.isArray(data)) {
                            result += `数组长度: ${data.length}\n`;
                            if (data.length > 0) {
                                result += `第一项示例: ${JSON.stringify(data[0], null, 2)}`;
                            }
                        }
                        resultDiv.className = 'result success';
                    } catch (parseError) {
                        result += `\n\nJSON 解析失败: ${parseError.message}`;
                        resultDiv.className = 'result error';
                    }
                } else {
                    resultDiv.className = 'result error';
                }

                resultDiv.textContent = result;

            } catch (error) {
                console.error('API测试失败:', error);
                resultDiv.className = 'result error';
                resultDiv.textContent = `网络错误: ${error.message}\n\n详细信息:\n${error.stack}`;
            }
        }

        async function testBasicInfo() {
            const resultDiv = document.getElementById('basicResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';

            let result = `当前页面信息:\n`;
            result += `URL: ${window.location.href}\n`;
            result += `协议: ${window.location.protocol}\n`;
            result += `主机: ${window.location.host}\n`;
            result += `路径: ${window.location.pathname}\n\n`;
            
            result += `浏览器信息:\n`;
            result += `User Agent: ${navigator.userAgent}\n`;
            result += `语言: ${navigator.language}\n`;
            result += `在线状态: ${navigator.onLine ? '在线' : '离线'}\n\n`;
            
            result += `支持的功能:\n`;
            result += `Fetch API: ${typeof fetch !== 'undefined' ? '支持' : '不支持'}\n`;
            result += `Promise: ${typeof Promise !== 'undefined' ? '支持' : '不支持'}\n`;
            result += `localStorage: ${typeof localStorage !== 'undefined' ? '支持' : '不支持'}\n`;

            resultDiv.textContent = result;
        }

        async function testNetwork() {
            const resultDiv = document.getElementById('networkResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.textContent = '正在测试网络连接...';

            try {
                // 测试基本连接
                const startTime = Date.now();
                const response = await fetch('/', { method: 'HEAD' });
                const endTime = Date.now();

                let result = `网络连接测试:\n`;
                result += `主页访问: ${response.ok ? '成功' : '失败'} (${response.status})\n`;
                result += `响应时间: ${endTime - startTime}ms\n\n`;

                // 测试API路径
                try {
                    const apiResponse = await fetch('/api/manage/list', { method: 'HEAD' });
                    result += `API路径访问: ${apiResponse.status}\n`;
                } catch (apiError) {
                    result += `API路径访问: 失败 - ${apiError.message}\n`;
                }

                resultDiv.className = response.ok ? 'result success' : 'result error';
                resultDiv.textContent = result;

            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `网络连接失败: ${error.message}`;
            }
        }

        async function testCORS() {
            const resultDiv = document.getElementById('corsResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.textContent = '正在测试 CORS 设置...';

            try {
                const response = await fetch('/api/manage/list', {
                    method: 'OPTIONS'
                });

                let result = `CORS 预检请求:\n`;
                result += `状态码: ${response.status}\n`;
                result += `Access-Control-Allow-Origin: ${response.headers.get('Access-Control-Allow-Origin') || '未设置'}\n`;
                result += `Access-Control-Allow-Methods: ${response.headers.get('Access-Control-Allow-Methods') || '未设置'}\n`;
                result += `Access-Control-Allow-Headers: ${response.headers.get('Access-Control-Allow-Headers') || '未设置'}\n`;

                resultDiv.className = 'result';
                resultDiv.textContent = result;

            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `CORS 测试失败: ${error.message}`;
            }
        }

        // 页面加载时自动运行基础测试
        window.addEventListener('load', () => {
            console.log('页面加载完成，开始自动测试');
            testBasicInfo();
        });
    </script>
</body>
</html>
