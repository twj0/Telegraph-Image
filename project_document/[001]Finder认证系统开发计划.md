# [001] Finder认证系统开发计划

**创建时间:** 2025-09-23T08:41:00+08:00  
**项目:** Telegraph-Image Finder访问控制功能  
**目标:** 为/finder路由添加用户认证和访问控制

## 📋 项目概述

### 需求描述
为Telegraph-Image项目的Finder子系统添加访问控制功能，包括：
- 用户认证机制（用户名/密码验证）
- 登录表单页面
- 会话管理（24小时有效期）
- 路由保护（未认证用户重定向到登录页）
- 数据库存储用户信息（单一管理员账户）

### 技术方案
- **数据库**: Better-SQLite3 (同步API，高性能)
- **密码加密**: bcrypt (salt rounds=12)
- **会话管理**: express-session (24小时有效期)
- **认证中间件**: 自定义路由保护

## 🎯 详细任务列表

### ✅ Phase 1: 环境准备和依赖配置
- [x] **任务1.1**: 修改finder/package.json添加新依赖
  - [x] 添加sqlite3依赖 (替代better-sqlite3以避免编译问题)
  - [x] 添加bcrypt依赖
  - [x] 添加express-session依赖
  - [x] 验证依赖安装成功

### ✅ Phase 2: 数据库层实现
- [x] **任务2.1**: 创建数据库工具模块 (utils/database.js)
  - [x] 实现SQLite数据库连接 (使用sqlite3异步API)
  - [x] 创建users表结构
  - [x] 实现数据库初始化函数
  - [x] 添加用户CRUD操作方法

- [x] **任务2.2**: 实现用户管理功能
  - [x] 创建默认管理员账户 (用户名: admin, 密码: JkGWQzZmhGUB)
  - [x] 实现密码加密和验证 (bcrypt, salt rounds=12)
  - [x] 添加用户查询和更新方法

### ✅ Phase 3: 认证中间件开发
- [x] **任务3.1**: 创建认证中间件 (middleware/auth.js)
  - [x] 实现会话检查逻辑
  - [x] 创建路由保护中间件
  - [x] 添加重定向处理
  - [x] 实现登录状态验证

### ✅ Phase 4: 登录界面开发
- [x] **任务4.1**: 创建登录页面 (views/login.html)
  - [x] 设计与现有UI风格一致的登录表单
  - [x] 实现响应式布局
  - [x] 添加错误提示显示
  - [x] 集成前端验证逻辑

### ✅ Phase 5: 认证API实现
- [x] **任务5.1**: 实现登录API路由
  - [x] POST /finder/login - 处理登录请求
  - [x] GET /finder/login - 显示登录页面
  - [x] GET /finder/logout - 处理登出请求
  - [x] 添加会话管理逻辑

- [x] **任务5.2**: 集成会话管理
  - [x] 配置express-session中间件
  - [x] 设置24小时会话有效期
  - [x] 实现安全的cookie配置
  - [x] 添加会话清理机制

### ✅ Phase 6: 路由保护集成
- [x] **任务6.1**: 修改现有路由添加认证保护
  - [x] 保护GET /finder主路由
  - [x] 保护相关API端点
  - [x] 实现自动重定向逻辑
  - [x] 测试认证流程

### ✅ Phase 7: 安全性增强
- [x] **任务7.1**: 实现安全配置
  - [x] 配置强随机session secret
  - [x] 启用HttpOnly和Secure cookies
  - [x] 添加基础安全防护
  - [x] 实现输入验证和清理

### ✅ Phase 8: 测试和优化
- [x] **任务8.1**: 功能测试
  - [x] 测试服务器启动和数据库初始化
  - [x] 验证默认管理员账户创建 (admin/JkGWQzZmhGUB)
  - [x] 测试路由保护效果
  - [x] 检查错误处理机制

- [ ] **任务8.2**: 用户体验测试
  - [ ] 测试登录页面访问
  - [ ] 验证登录/登出流程
  - [ ] 测试响应式布局
  - [ ] 验证自动重定向功能

## 📁 文件结构规划

```
finder/
├── server.js (修改：添加认证功能)
├── package.json (修改：添加新依赖)
├── auth.db (新建：SQLite数据库文件)
├── views/ (新建目录)
│   └── login.html (新建：登录页面)
├── middleware/ (新建目录)
│   └── auth.js (新建：认证中间件)
└── utils/ (新建目录)
    └── database.js (新建：数据库工具)
```

## 🔒 安全考虑

1. **密码安全**: 使用bcrypt加密，salt rounds=12
2. **会话安全**: 强随机secret，HttpOnly+Secure cookies
3. **输入验证**: 验证用户名和密码格式
4. **错误处理**: 统一错误响应，避免信息泄露
5. **默认配置**: 安全的默认设置

## 📊 验收标准

1. ✅ 用户可以通过用户名/密码登录
2. ✅ 未认证用户访问/finder时自动重定向到登录页
3. ✅ 会话在24小时内保持有效
4. ✅ 登录页面与现有UI风格一致
5. ✅ 密码使用bcrypt安全加密存储
6. ✅ 系统支持安全的登出功能
7. ✅ 错误处理友好且安全

## 🚀 部署注意事项

1. 确保SQLite数据库文件有正确的读写权限
2. 生产环境需要配置HTTPS以启用secure cookies
3. 定期备份auth.db数据库文件
4. 监控会话存储的内存使用情况

---

**状态**: 📋 规划完成，等待执行  
**预计工期**: 1-2个工作日  
**风险评估**: 低风险，技术方案成熟可靠
