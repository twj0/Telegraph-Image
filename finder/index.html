<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegraph Finder - æ–‡ä»¶ç®¡ç†å™¨</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">

    <!-- Override CSS to fix image rendering issue -->
    <style>
        /* Override the 64px constraint from styles.css */
        .file-icon.image img {
            width: 100% !important;
            height: 120px !important;
            max-width: none !important;
            max-height: none !important;
            min-width: 120px !important;
            min-height: 120px !important;
            object-fit: cover !important;
            border-radius: 8px !important;
            display: block !important;
        }

        /* Ensure parent container has proper size */
        .file-icon.image {
            width: 100% !important;
            height: 120px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            overflow: hidden !important;
            border-radius: 8px !important;
            background: #f0f0f0 !important;
        }

        /* Ensure file item container is properly sized */
        .file-item {
            min-height: 180px !important;
            display: flex !important;
            flex-direction: column !important;
            align-items: center !important;
            justify-content: flex-start !important;
            padding: 12px !important;
            background: #f8f9fa !important;
            border-radius: 12px !important;
            cursor: pointer !important;
            transition: all 0.2s ease !important;
        }

        /* æ–‡ä»¶å¤¹æ ·å¼ */
        .folder-item {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
            border: 2px solid transparent !important;
        }

        .folder-item:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3) !important;
            border-color: rgba(255, 255, 255, 0.3) !important;
        }

        .folder-item .file-icon {
            background: transparent !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            height: 120px !important;
        }

        .folder-item .file-name {
            color: white !important;
            font-weight: 600 !important;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1) !important;
        }

        .folder-item .file-size {
            color: rgba(255, 255, 255, 0.8) !important;
            font-size: 12px !important;
        }

        /* æ–°å»ºæ–‡ä»¶å¤¹æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            background: rgba(0, 0, 0, 0.5) !important;
            display: none !important;
            align-items: center !important;
            justify-content: center !important;
            z-index: 1000 !important;
        }

        .modal.show {
            display: flex !important;
        }

        .modal-content {
            background: white !important;
            border-radius: 12px !important;
            padding: 24px !important;
            width: 90% !important;
            max-width: 400px !important;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3) !important;
        }

        .modal-header {
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            margin-bottom: 20px !important;
        }

        .modal-close {
            background: none !important;
            border: none !important;
            font-size: 18px !important;
            cursor: pointer !important;
            color: #999 !important;
        }

        .form-group {
            margin-bottom: 16px !important;
        }

        .form-group label {
            display: block !important;
            margin-bottom: 6px !important;
            font-weight: 600 !important;
            color: #333 !important;
        }

        .form-group input {
            width: 100% !important;
            padding: 10px 12px !important;
            border: 2px solid #e1e5e9 !important;
            border-radius: 8px !important;
            font-size: 14px !important;
        }

        .color-picker {
            display: flex !important;
            align-items: center !important;
            gap: 12px !important;
        }

        .color-presets {
            display: flex !important;
            gap: 8px !important;
        }

        .color-preset {
            width: 24px !important;
            height: 24px !important;
            border-radius: 50% !important;
            cursor: pointer !important;
            border: 2px solid transparent !important;
            transition: all 0.2s ease !important;
        }

        .color-preset:hover,
        .color-preset.selected {
            border-color: #333 !important;
            transform: scale(1.1) !important;
        }

        .form-actions {
            display: flex !important;
            gap: 12px !important;
            justify-content: flex-end !important;
            margin-top: 24px !important;
        }

        .btn-secondary, .btn-primary {
            padding: 10px 20px !important;
            border: none !important;
            border-radius: 8px !important;
            font-weight: 600 !important;
            cursor: pointer !important;
            transition: all 0.2s ease !important;
        }

        .btn-secondary {
            background: #f8f9fa !important;
            color: #6c757d !important;
        }

        .btn-primary {
            background: #007bff !important;
            color: white !important;
        }

        .btn-secondary:hover {
            background: #e9ecef !important;
        }

        .btn-primary:hover {
            background: #0056b3 !important;
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å·¥å…·æ  -->
    <header class="toolbar">
        <div class="toolbar-left">
            <button id="backBtn" class="btn-icon" title="è¿”å›">
                <i class="fas fa-arrow-left"></i>
            </button>
            <button id="forwardBtn" class="btn-icon" title="å‰è¿›">
                <i class="fas fa-arrow-right"></i>
            </button>
            <div class="breadcrumb" id="breadcrumb">
                <span class="breadcrumb-item">å…¨éƒ¨æ–‡ä»¶</span>
            </div>
        </div>
        <div class="toolbar-right">
            <button id="viewModeBtn" class="btn-icon" title="åˆ‡æ¢è§†å›¾">
                <i class="fas fa-th"></i>
            </button>
            <button id="newFolderBtn" class="btn-secondary" title="æ–°å»ºæ–‡ä»¶å¤¹">
                <i class="fas fa-folder-plus"></i>
                æ–°å»ºæ–‡ä»¶å¤¹
            </button>
            <button id="refreshBtn" class="btn-secondary" title="åˆ·æ–°å›¾ç‰‡åˆ—è¡¨">
                <i class="fas fa-sync-alt"></i>
                åˆ·æ–°
            </button>
            <button id="uploadBtn" class="btn-primary">
                <i class="fas fa-upload"></i>
                ä¸Šä¼ å›¾ç‰‡
            </button>
        </div>
    </header>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <main class="main-content">
        <!-- ä¾§è¾¹æ  -->
        <aside class="sidebar">
            <div class="sidebar-section">
                <h3>å›¾ç‰‡ç®¡ç†</h3>
                <ul class="nav-list">
                    <li class="nav-item active" data-path="/" data-folder-type="system">
                        <i class="fas fa-images"></i>
                        <span>å…¨éƒ¨å›¾ç‰‡</span>
                    </li>
                    <li class="nav-item" data-path="/recent" data-folder-type="system">
                        <i class="fas fa-clock"></i>
                        <span>æœ€è¿‘ä½¿ç”¨</span>
                    </li>
                    <li class="nav-item" data-path="/favorites" data-folder-type="system">
                        <i class="fas fa-star"></i>
                        <span>æ”¶è—å¤¹</span>
                    </li>
                </ul>
            </div>

            <div class="sidebar-section">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <h3>æˆ‘çš„æ–‡ä»¶å¤¹</h3>
                    <button id="sidebarNewFolderBtn" class="btn-icon" title="æ–°å»ºæ–‡ä»¶å¤¹" style="font-size: 12px; padding: 4px;">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                <ul class="nav-list" id="customFoldersList">
                    <!-- åŠ¨æ€åŠ è½½çš„è‡ªå®šä¹‰æ–‡ä»¶å¤¹ -->
                </ul>
            </div>

            <div class="sidebar-section">
                <h3>å¿«é€Ÿæ“ä½œ</h3>
                <ul class="nav-list">
                    <li class="nav-item action-item" data-action="refresh">
                        <i class="fas fa-sync-alt"></i>
                        <span>åˆ·æ–°åˆ—è¡¨</span>
                    </li>
                    <li class="nav-item action-item" data-action="clear-cache">
                        <i class="fas fa-broom"></i>
                        <span>æ¸…ç†ç¼“å­˜</span>
                    </li>
                </ul>
            </div>
        </aside>

        <!-- æ–‡ä»¶æ˜¾ç¤ºåŒºåŸŸ -->
        <section class="file-area">
            <!-- åŠ è½½çŠ¶æ€ -->
            <div id="loadingState" class="loading-state">
                <div class="spinner"></div>
                <p>åŠ è½½ä¸­...</p>
            </div>

            <!-- ç©ºçŠ¶æ€ -->
            <div id="emptyState" class="empty-state" style="display: none;">
                <div class="empty-icon">
                    <i class="fas fa-images"></i>
                </div>
                <h3>è¿˜æ²¡æœ‰å›¾ç‰‡</h3>
                <p>æ‹–æ‹½å›¾ç‰‡åˆ°è¿™é‡Œæˆ–ç‚¹å‡»ä¸Šä¼ æŒ‰é’®å¼€å§‹ä½¿ç”¨</p>
                <button class="btn-primary" onclick="document.getElementById('fileInput').click()">
                    <i class="fas fa-upload"></i>
                    ä¸Šä¼ å›¾ç‰‡
                </button>
            </div>

            <!-- æ–‡ä»¶ç½‘æ ¼ -->
            <div id="fileGrid" class="file-grid" style="display: none;">
                <!-- åŠ¨æ€ç”Ÿæˆçš„æ–‡ä»¶é¡¹ -->
            </div>

            <!-- æ–‡ä»¶åˆ—è¡¨è§†å›¾ -->
            <div id="fileList" class="file-list" style="display: none;">
                <table>
                    <thead>
                        <tr>
                            <th>åç§°</th>
                            <th>å¤§å°</th>
                            <th>ç±»å‹</th>
                            <th>ä¿®æ”¹æ—¶é—´</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="fileListBody">
                        <!-- åŠ¨æ€ç”Ÿæˆçš„æ–‡ä»¶è¡Œ -->
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <!-- éšè—çš„æ–‡ä»¶è¾“å…¥ -->
    <input type="file" id="fileInput" multiple style="display: none;">

    <!-- ä¸Šä¼ è¿›åº¦æ¨¡æ€æ¡† -->
    <div id="uploadModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>æ–‡ä»¶ä¸Šä¼ </h3>
                <button class="modal-close" onclick="closeUploadModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="uploadProgress">
                    <!-- åŠ¨æ€ç”Ÿæˆçš„ä¸Šä¼ è¿›åº¦é¡¹ -->
                </div>
            </div>
        </div>
    </div>

    <!-- å›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡† -->
    <div id="imagePreviewModal" class="modal" style="display: none;">
        <div class="modal-backdrop" onclick="imageFinder.closeImagePreview()"></div>
        <div class="image-preview-content">
            <div class="preview-header">
                <h3 id="previewImageName">å›¾ç‰‡é¢„è§ˆ</h3>
                <div class="preview-actions">
                    <button class="btn-icon" onclick="imageFinder.toggleFavorite()" id="favoriteBtn">
                        <i class="fas fa-star"></i>
                    </button>
                    <button class="btn-icon" onclick="imageFinder.downloadCurrentImage()">
                        <i class="fas fa-download"></i>
                    </button>
                    <button class="btn-icon" onclick="imageFinder.copyImageLink()">
                        <i class="fas fa-link"></i>
                    </button>
                    <button class="btn-icon" onclick="imageFinder.closeImagePreview()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="preview-body">
                <img id="previewImage" src="" alt="é¢„è§ˆå›¾ç‰‡">
                <div class="preview-info">
                    <div class="info-item">
                        <span class="label">æ–‡ä»¶å¤§å°:</span>
                        <span id="previewSize">-</span>
                    </div>
                    <div class="info-item">
                        <span class="label">ä¸Šä¼ æ—¶é—´:</span>
                        <span id="previewDate">-</span>
                    </div>
                    <div class="info-item">
                        <span class="label">å›¾ç‰‡é“¾æ¥:</span>
                        <input type="text" id="previewUrl" readonly onclick="this.select()">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å³é”®èœå• -->
    <div id="contextMenu" class="context-menu">
        <!-- èœå•é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
    </div>

    <!-- åå°ä¸Šä¼ è¿›åº¦å®¹å™¨ -->
    <div id="backgroundUploadContainer" class="background-upload-container">
        <!-- ä¸Šä¼ ä»»åŠ¡å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
    </div>

    <!-- æ–°å»ºæ–‡ä»¶å¤¹æ¨¡æ€æ¡† -->
    <div id="newFolderModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>æ–°å»ºæ–‡ä»¶å¤¹</h3>
                <button class="modal-close" id="modalCloseBtn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="folderNameInput">æ–‡ä»¶å¤¹åç§°</label>
                    <input type="text" id="folderNameInput" placeholder="è¯·è¾“å…¥æ–‡ä»¶å¤¹åç§°" maxlength="50">
                </div>
                <div class="form-group">
                    <label for="folderColorInput">æ–‡ä»¶å¤¹é¢œè‰²</label>
                    <div class="color-picker">
                        <input type="color" id="folderColorInput" value="#4A90E2">
                        <div class="color-presets">
                            <span class="color-preset" data-color="#4A90E2" style="background: #4A90E2;"></span>
                            <span class="color-preset" data-color="#34C759" style="background: #34C759;"></span>
                            <span class="color-preset" data-color="#FF9500" style="background: #FF9500;"></span>
                            <span class="color-preset" data-color="#FF3B30" style="background: #FF3B30;"></span>
                            <span class="color-preset" data-color="#AF52DE" style="background: #AF52DE;"></span>
                            <span class="color-preset" data-color="#007AFF" style="background: #007AFF;"></span>
                        </div>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-secondary" id="cancelFolderBtn">å–æ¶ˆ</button>
                    <button type="button" class="btn-primary" id="createFolderBtn">åˆ›å»º</button>
                </div>
            </div>
        </div>
    </div>

    <!-- é€šçŸ¥å®¹å™¨ -->
    <div id="notifications" class="notifications"></div>

    <script>
        // æç®€ç‰ˆTelegraphå›¾ç‰‡æŸ¥çœ‹å™¨ - å†…è”ç‰ˆæœ¬
        class SimpleImageViewer {
            constructor() {
                this.images = [];
                this.folders = new Map();
                this.currentPath = '/';
                this.currentFolderId = null;
                console.log('ğŸš€ Simple Image Viewer å¯åŠ¨...');
                this.init();
            }

            async init() {
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', () => this.start());
                } else {
                    this.start();
                }
            }

            async start() {
                console.log('ğŸ“¸ å¼€å§‹åŠ è½½å›¾ç‰‡...');
                console.log('ğŸŒ ç”¨æˆ·ä»£ç†:', navigator.userAgent);
                console.log('ğŸ–¥ï¸ å±å¹•å°ºå¯¸:', window.innerWidth + 'x' + window.innerHeight);

                this.hideLoading();
                this.bindEvents();

                // æ¢å¤é¡µé¢çŠ¶æ€
                this.restorePageState();

                await this.loadFolders(true); // ä¼˜å…ˆåŒæ­¥æœåŠ¡å™¨ç«¯æ–‡ä»¶å¤¹
                await this.loadImages(true); // é¦–æ¬¡åŠ è½½å¼ºåˆ¶åˆ·æ–°
                this.renderImages();
                this.renderSidebar(); // æ¸²æŸ“ä¾§è¾¹æ 
                this.startPeriodicCheck(); // å¯åŠ¨å®šæœŸæ£€æŸ¥

                // æ·»åŠ é¢å¤–çš„è°ƒè¯•ä¿¡æ¯
                this.debugPageState();

                // æ£€æŸ¥URLè·¯ç”±ï¼ˆæ”¾åœ¨æœ€åæ‰§è¡Œï¼‰
                setTimeout(() => {
                    this.checkUrlRouting();
                }, 1000);

                console.log('âœ… å›¾ç‰‡åŠ è½½å®Œæˆ');
            }

            // æ¢å¤é¡µé¢çŠ¶æ€
            restorePageState() {
                try {
                    const savedState = localStorage.getItem('telegraph_page_state');
                    if (savedState) {
                        const state = JSON.parse(savedState);
                        this.currentPath = state.currentPath || '/';
                        this.currentFolderId = state.currentFolderId || 'all';
                        console.log('ğŸ“„ æ¢å¤é¡µé¢çŠ¶æ€:', state);
                    }
                } catch (error) {
                    console.error('æ¢å¤é¡µé¢çŠ¶æ€å¤±è´¥:', error);
                }
            }

            // ä¿å­˜é¡µé¢çŠ¶æ€
            savePageState() {
                try {
                    const state = {
                        currentPath: this.currentPath,
                        currentFolderId: this.currentFolderId,
                        timestamp: Date.now()
                    };
                    localStorage.setItem('telegraph_page_state', JSON.stringify(state));
                } catch (error) {
                    console.error('ä¿å­˜é¡µé¢çŠ¶æ€å¤±è´¥:', error);
                }
            }

            // æ£€æŸ¥URLè·¯ç”±å¹¶æ‰§è¡Œç›¸åº”æ“ä½œ
            checkUrlRouting() {
                const path = window.location.pathname;
                const hash = window.location.hash;

                console.log('ğŸ”— æ£€æŸ¥URLè·¯ç”±:', path, hash);

                // æ£€æŸ¥æ˜¯å¦æ˜¯æ–°å»ºæ–‡ä»¶å¤¹è·¯ç”±
                if (path.includes('/finder/new') || hash === '#new') {
                    console.log('ğŸ“ æ£€æµ‹åˆ°æ–°å»ºæ–‡ä»¶å¤¹è·¯ç”±ï¼Œè‡ªåŠ¨æ‰“å¼€æ–°å»ºæ–‡ä»¶å¤¹æ¨¡æ€æ¡†');
                    // ç«‹å³æ‰§è¡Œï¼Œä¸éœ€è¦å»¶è¿Ÿ
                    this.showNewFolderModal();
                    // æ¸…é™¤URLä¸­çš„è·¯ç”±æ ‡è¯†ï¼Œé¿å…é‡å¤è§¦å‘
                    if (path.includes('/finder/new')) {
                        window.history.replaceState({}, '', '/finder/');
                    } else if (hash === '#new') {
                        window.history.replaceState({}, '', window.location.pathname);
                    }
                }
            }

            // ä¼˜åŒ–è°ƒè¯•åŠŸèƒ½ - å‡å°‘å»¶è¿Ÿå’Œæ—¥å¿—
            debugPageState() {
                // åªåœ¨å¼€å‘æ¨¡å¼ä¸‹è¾“å‡ºè¯¦ç»†æ—¥å¿—
                const isDev = window.location.hostname === 'localhost';
                if (!isDev) return;

                // å‡å°‘å»¶è¿Ÿ
                setTimeout(() => {
                    console.log('ğŸ” è°ƒè¯•é¡µé¢çŠ¶æ€...');

                    const fileArea = document.querySelector('.file-area');
                    const fileGrid = document.getElementById('fileGrid');
                    const images = document.querySelectorAll('.file-icon.image img');

                    // ç®€åŒ–æ—¥å¿—è¾“å‡º
                    console.log(`ğŸ“Š é¡µé¢çŠ¶æ€: fileArea=${!!fileArea}, fileGrid=${!!fileGrid}, å›¾ç‰‡=${images.length}`);

                    if (fileArea && fileGrid) {
                        const fileAreaDisplay = window.getComputedStyle(fileArea).display;
                        const fileGridDisplay = window.getComputedStyle(fileGrid).display;
                        console.log(`ğŸ“Š æ˜¾ç¤ºçŠ¶æ€: fileArea=${fileAreaDisplay}, fileGrid=${fileGridDisplay}`);
                    }

                    // åªè¾“å‡ºç¬¬ä¸€å¼ å›¾ç‰‡çš„ä¿¡æ¯ä½œä¸ºç¤ºä¾‹
                    if (images.length > 0) {
                        const firstImg = images[0];
                        const rect = firstImg.getBoundingClientRect();
                        console.log(`ğŸ“Š å›¾ç‰‡ç¤ºä¾‹: ${firstImg.clientWidth}x${firstImg.clientHeight}, å¯è§=${rect.width > 0}`);
                    }

                    console.log('ğŸ” è°ƒè¯•å®Œæˆ');
                }, 200); // å‡å°‘å»¶è¿Ÿä»1000msåˆ°200ms
            }

            // ä¼˜åŒ–å®šæœŸæ£€æŸ¥æœºåˆ¶ - å‡å°‘é¢‘ç‡å’Œæ€§èƒ½å½±å“
            startPeriodicCheck() {
                // å»¶é•¿æ£€æŸ¥é—´éš”åˆ°60ç§’ï¼Œå‡å°‘æ€§èƒ½å½±å“
                setInterval(async () => {
                    // åªåœ¨é¡µé¢å¯è§æ—¶æ£€æŸ¥æ›´æ–°
                    if (!document.hidden) {
                        await this.checkForUpdates();
                    }
                }, 60000);

                // é¡µé¢è·å¾—ç„¦ç‚¹æ—¶ä¹Ÿæ£€æŸ¥æ›´æ–°ï¼ˆä½†å¢åŠ é˜²æŠ–ï¼‰
                let focusTimeout;
                window.addEventListener('focus', async () => {
                    clearTimeout(focusTimeout);
                    focusTimeout = setTimeout(async () => {
                        console.log('ğŸ” é¡µé¢è·å¾—ç„¦ç‚¹ï¼Œæ£€æŸ¥æ›´æ–°...');
                        await this.checkForUpdates();
                    }, 1000); // 1ç§’é˜²æŠ–
                });

                console.log('ğŸ”„ å·²å¯åŠ¨ä¼˜åŒ–çš„å®šæœŸæ£€æŸ¥æœºåˆ¶');
            }

            hideLoading() {
                const loadingElement = document.querySelector('.loading-state');
                if (loadingElement) loadingElement.style.display = 'none';

                const fileArea = document.querySelector('.file-area');
                if (fileArea) fileArea.style.display = 'block';
            }

            bindEvents() {
                // ä¸Šä¼ æŒ‰é’®
                const uploadBtn = document.getElementById('uploadBtn');
                if (uploadBtn) {
                    uploadBtn.addEventListener('click', () => {
                        const fileInput = document.getElementById('fileInput');
                        if (fileInput) fileInput.click();
                    });
                }

                // æ–°å»ºæ–‡ä»¶å¤¹æŒ‰é’®
                const newFolderBtn = document.getElementById('newFolderBtn');
                if (newFolderBtn) {
                    newFolderBtn.addEventListener('click', () => {
                        this.showNewFolderModal();
                    });
                }

                // ä¾§è¾¹æ æ–°å»ºæ–‡ä»¶å¤¹æŒ‰é’®
                const sidebarNewFolderBtn = document.getElementById('sidebarNewFolderBtn');
                if (sidebarNewFolderBtn) {
                    sidebarNewFolderBtn.addEventListener('click', () => {
                        this.showNewFolderModal();
                    });
                }

                // åˆ·æ–°æŒ‰é’®
                const refreshBtn = document.getElementById('refreshBtn');
                if (refreshBtn) {
                    refreshBtn.addEventListener('click', async () => {
                        console.log('ğŸ”„ æ‰‹åŠ¨åˆ·æ–°å›¾ç‰‡åˆ—è¡¨...');
                        refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> åˆ·æ–°ä¸­...';
                        refreshBtn.disabled = true;

                        try {
                            await this.loadFolders();
                            await this.loadImages(true);
                            this.renderImages();
                            this.renderSidebar();
                            this.showSuccessMessage('åˆ—è¡¨å·²åˆ·æ–°ï¼');
                        } finally {
                            refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> åˆ·æ–°';
                            refreshBtn.disabled = false;
                        }
                    });
                }

                // ä¾§è¾¹æ æ“ä½œé¡¹äº‹ä»¶
                const actionItems = document.querySelectorAll('.action-item');
                actionItems.forEach(item => {
                    item.addEventListener('click', () => {
                        const action = item.dataset.action;
                        if (action === 'refresh') {
                            document.getElementById('refreshBtn').click();
                        } else if (action === 'clear-cache') {
                            if (confirm('ç¡®å®šè¦æ¸…ç†ç¼“å­˜å—ï¼Ÿè¿™å°†åˆ·æ–°é¡µé¢ã€‚')) {
                                this.clearCache();
                            }
                        }
                    });
                });

                // ç³»ç»Ÿæ–‡ä»¶å¤¹å¯¼èˆª
                const systemNavItems = document.querySelectorAll('.nav-item[data-folder-type="system"]');
                systemNavItems.forEach(item => {
                    item.addEventListener('click', () => {
                        document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                        item.classList.add('active');

                        const path = item.dataset.path || '/';
                        let targetId = 'all';

                        if (path.includes('recent')) {
                            targetId = 'recent';
                        } else if (path.includes('favorites')) {
                            targetId = 'favorites';
                        }

                        this.currentFolderId = targetId;
                        this.currentPath = targetId === 'all' ? '/' : `/${targetId}`;
                        this.savePageState();

                        this.loadImages(true).then(() => {
                            this.renderImages();
                            this.renderSidebar();
                            this.updateActiveNavigation();
                        });

                        this.updateBreadcrumb();
                        this.updateActiveNavigation();
                    });
                });

                // æ–‡ä»¶è¾“å…¥
                const fileInput = document.getElementById('fileInput');
                if (fileInput) {
                    fileInput.addEventListener('change', (e) => {
                        this.handleFileUpload(e.target.files);
                    });
                }

                // æ‹–æ‹½ä¸Šä¼ 
                const fileArea = document.querySelector('.file-area');
                if (fileArea) {
                    fileArea.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        fileArea.classList.add('drag-over');
                    });

                    fileArea.addEventListener('dragleave', (e) => {
                        e.preventDefault();
                        fileArea.classList.remove('drag-over');
                    });

                    fileArea.addEventListener('drop', (e) => {
                        e.preventDefault();
                        fileArea.classList.remove('drag-over');
                        this.handleFileUpload(e.dataTransfer.files);
                    });
                }
            }

            // æ¸…ç†ç¼“å­˜åŠŸèƒ½
            clearCache() {
                try {
                    // æ¸…ç†localStorage
                    localStorage.removeItem('telegraph_image_list');
                    localStorage.removeItem('finder_folders');
                    localStorage.removeItem('finder_folder_structure');
                    localStorage.removeItem('telegraph_folders_cache');
                    localStorage.removeItem('telegraph_page_state');
                    
                    // æ¸…ç†æ‰€æœ‰ä»¥folder_å¼€å¤´çš„é¡¹
                    const keysToRemove = [];
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && key.startsWith('folder_')) {
                            keysToRemove.push(key);
                        }
                    }
                    keysToRemove.forEach(key => localStorage.removeItem(key));
                    
                    // æ¸…ç†sessionStorage
                    sessionStorage.clear();
                    
                    this.showNotification('ç¼“å­˜å·²æ¸…ç†ï¼Œé¡µé¢å°†è‡ªåŠ¨åˆ·æ–°', 'success');
                    
                    // å»¶è¿Ÿåˆ·æ–°é¡µé¢
                    setTimeout(() => {
                        window.location.reload(true);
                    }, 1500);
                    
                    console.log('âœ… ç¼“å­˜æ¸…ç†å®Œæˆ');
                } catch (error) {
                    console.error('âŒ æ¸…ç†ç¼“å­˜å¤±è´¥:', error);
                    this.showNotification('æ¸…ç†ç¼“å­˜å¤±è´¥: ' + error.message, 'error');
                }
            }

            async loadImages(forceRefresh = false) {
                console.log('ğŸ“¸ åŠ è½½å›¾ç‰‡åˆ—è¡¨...', forceRefresh ? '(å¼ºåˆ¶åˆ·æ–°)' : '');

                try {
                    // æ·»åŠ æ—¶é—´æˆ³é¿å…ç¼“å­˜
                    const timestamp = forceRefresh ? `?t=${Date.now()}` : '';
                    const response = await fetch(`/api/manage/list${timestamp}`, {
                        method: 'GET',
                        headers: {
                            'Cache-Control': 'no-cache',
                            'Pragma': 'no-cache'
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        this.images = this.filterImages(data);
                        this.updateFolderCounts();
                        console.log(`âœ… åŠ è½½äº† ${this.images.length} å¼ å›¾ç‰‡`);

                        // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ï¼Œç”¨äºè·¨æµè§ˆå™¨åŒæ­¥æ£€æµ‹
                        this.saveImageListToStorage();
                    } else {
                        throw new Error(`HTTP ${response.status}`);
                    }
                } catch (error) {
                    console.log('ğŸ­ APIä¸å¯ç”¨ï¼Œä½¿ç”¨æ¼”ç¤ºæ•°æ®');
                    this.images = this.getDemoImages();
                    this.updateFolderCounts();
                }
            }

            // ä¿å­˜å›¾ç‰‡åˆ—è¡¨åˆ°æœ¬åœ°å­˜å‚¨
            saveImageListToStorage() {
                try {
                    const imageList = this.images.map(img => ({
                        id: img.id,
                        name: img.name,
                        size: img.size,
                        uploadDate: img.uploadDate
                    }));
                    localStorage.setItem('telegraph_image_list', JSON.stringify({
                        timestamp: Date.now(),
                        images: imageList
                    }));
                } catch (error) {
                    console.error('ä¿å­˜å›¾ç‰‡åˆ—è¡¨å¤±è´¥:', error);
                }
            }

            // æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ·æ–°ï¼ˆè·¨æµè§ˆå™¨åŒæ­¥ï¼‰
            async checkForUpdates() {
                try {
                    const stored = localStorage.getItem('telegraph_image_list');
                    if (!stored) return;

                    const { timestamp, images: storedImages } = JSON.parse(stored);
                    const currentImages = this.images.map(img => img.id).sort();
                    const storedImageIds = storedImages.map(img => img.id).sort();

                    // å¦‚æœå›¾ç‰‡åˆ—è¡¨ä¸ä¸€è‡´ï¼Œå¼ºåˆ¶åˆ·æ–°
                    if (JSON.stringify(currentImages) !== JSON.stringify(storedImageIds)) {
                        console.log('ğŸ”„ æ£€æµ‹åˆ°å›¾ç‰‡åˆ—è¡¨å˜åŒ–ï¼Œè‡ªåŠ¨åˆ·æ–°...');
                        await this.loadImages(true);
                        this.renderImages();
                        this.renderSidebar();
                    }
                } catch (error) {
                    console.error('æ£€æŸ¥æ›´æ–°å¤±è´¥:', error);
                }
            }

            filterImages(files) {
                if (!Array.isArray(files)) return [];

                let filteredFiles = files.filter(file => this.isImageFile(file.name));

                // æ ¹æ®å½“å‰æ–‡ä»¶å¤¹è¿‡æ»¤
                if (this.currentFolderId && this.currentFolderId !== 'all') {
                    if (this.currentFolderId === 'recent') {
                        // æœ€è¿‘ä½¿ç”¨ï¼šæ˜¾ç¤ºæœ€è¿‘7å¤©çš„å›¾ç‰‡
                        const sevenDaysAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
                        filteredFiles = filteredFiles.filter(file =>
                            (file.metadata?.TimeStamp || 0) > sevenDaysAgo
                        );
                    } else if (this.currentFolderId === 'favorites') {
                        // æ”¶è—å¤¹ï¼šæ˜¾ç¤ºæ”¶è—çš„å›¾ç‰‡
                        filteredFiles = filteredFiles.filter(file =>
                            file.metadata?.liked === true
                        );
                    } else {
                        // è‡ªå®šä¹‰æ–‡ä»¶å¤¹ï¼šæ ¹æ®folderIdæˆ–parentFolderè¿‡æ»¤
                        filteredFiles = filteredFiles.filter(file =>
                            file.metadata?.folderId === this.currentFolderId ||
                            file.metadata?.parentFolder === this.currentFolderId
                        );
                    }
                }

                return filteredFiles
                    .map(file => {
                        const rawFolderId = file.metadata?.folderId ?? file.metadata?.parentFolder ?? null;
                        const folderId = this.normalizeFolderId(rawFolderId);

                        return {
                            id: file.name,
                            name: file.metadata?.fileName || file.name,
                            size: file.metadata?.fileSize || 0,
                            url: `/file/${file.name}`,
                            uploadDate: new Date(file.metadata?.TimeStamp || Date.now()),
                            folderId,
                            rawFolderId,
                            liked: file.metadata?.liked || false
                        };
                    })
                    .sort((a, b) => b.uploadDate - a.uploadDate);
            }

            isImageFile(filename) {
                const imageExtensions = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg', 'bmp', 'ico'];
                const ext = filename.split('.').pop().toLowerCase();
                return imageExtensions.includes(ext);
            }

            // è§„èŒƒåŒ–æ–‡ä»¶å¤¹IDï¼Œç»Ÿä¸€å¤„ç†æ ¹ç›®å½•æ ‡è¯†
            normalizeFolderId(folderId) {
                if (folderId === undefined || folderId === null) {
                    return null;
                }

                const normalized = String(folderId).trim();
                if (normalized === '' || normalized === '/' || normalized === 'root' || normalized === 'all') {
                    return null;
                }

                return normalized;
            }

            // åˆ¤æ–­å½“å‰æ˜¯å¦å¤„äºæ ¹ç›®å½•è§†å›¾
            isRootView() {
                return (
                    !this.currentFolderId ||
                    this.currentFolderId === 'all' ||
                    this.currentFolderId === '/' ||
                    this.currentPath === '/'
                );
            }

            getDemoImages() {
                return [
                    {
                        id: 'demo_1',
                        name: 'æ¼”ç¤ºå›¾ç‰‡1.jpg',
                        size: 1024000,
                        url: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iIzQyODVmNCIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmaWxsPSJ3aGl0ZSIgZm9udC1zaXplPSIxNiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPuekuuS+i+WbvueJhzE8L3RleHQ+PC9zdmc+',
                        uploadDate: new Date(Date.now() - 86400000)
                    },
                    {
                        id: 'demo_2',
                        name: 'æ¼”ç¤ºå›¾ç‰‡2.png',
                        size: 2048000,
                        url: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iIzM0Yzc1OSIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmaWxsPSJ3aGl0ZSIgZm9udC1zaXplPSIxNiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPuekuuS+i+WbvueJhzI8L3RleHQ+PC9zdmc+',
                        uploadDate: new Date(Date.now() - 172800000)
                    },
                    {
                        id: 'demo_3',
                        name: 'æ¼”ç¤ºå›¾ç‰‡3.jpg',
                        size: 1536000,
                        url: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2ZmOTUwMCIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmaWxsPSJ3aGl0ZSIgZm9udC1zaXplPSIxNiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPuekuuS+i+WbvueJhzM8L3RleHQ+PC9zdmc+',
                        uploadDate: new Date(Date.now() - 259200000)
                    }
                ];
            }

            renderImages() {
                const fileGrid = document.getElementById('fileGrid');
                const emptyState = document.getElementById('emptyState');

                if (!fileGrid) {
                    console.error('âŒ æ‰¾ä¸åˆ°fileGridå…ƒç´ ');
                    return;
                }

                // è·å–å½“å‰æ–‡ä»¶å¤¹çš„å­æ–‡ä»¶å¤¹
                const subFolders = this.getCurrentSubFolders();

                // è·å–å½“å‰æ–‡ä»¶å¤¹çš„å›¾ç‰‡ï¼ˆæ ¹æ®æ–‡ä»¶å¤¹è¿‡æ»¤ï¼‰
                const currentImages = this.getCurrentFolderImages();
                const totalItems = subFolders.length + currentImages.length;

                if (totalItems === 0) {
                    if (emptyState) emptyState.style.display = 'flex';
                    fileGrid.style.display = 'none';
                    return;
                }

                if (emptyState) emptyState.style.display = 'none';
                fileGrid.style.display = 'grid';

                // æ¸²æŸ“æ–‡ä»¶å¤¹ï¼ˆæ’åœ¨å‰é¢ï¼‰
                const foldersHtml = subFolders.map(folder => `
                    <div class="file-item folder-item" data-folder-id="${folder.id}">
                        <div class="file-icon folder">
                            <i class="fas fa-folder" style="color: ${folder.color || '#4A90E2'}; font-size: 48px;"></i>
                        </div>
                        <div class="file-name" title="${folder.name}">${folder.name}</div>
                        <div class="file-size">${folder.fileCount || 0} ä¸ªæ–‡ä»¶</div>
                    </div>
                `).join('');

                // æ¸²æŸ“å›¾ç‰‡æ–‡ä»¶ï¼ˆåªæ˜¾ç¤ºå½“å‰æ–‡ä»¶å¤¹çš„å›¾ç‰‡ï¼‰
                const imagesHtml = currentImages.map(image => `
                    <div class="file-item image-item" data-image-id="${image.id}">
                        <div class="file-icon image">
                            <img src="${image.url}" alt="${image.name}" loading="lazy"
                                 style="
                                    width: 100% !important;
                                    height: 120px !important;
                                    max-width: none !important;
                                    max-height: none !important;
                                    min-width: 120px !important;
                                    min-height: 120px !important;
                                    object-fit: cover !important;
                                    border-radius: 8px !important;
                                    display: block !important;
                                 "
                                 onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjEyMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTIwIiBoZWlnaHQ9IjEyMCIgZmlsbD0iI2Y1ZjVmNSIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmaWxsPSIjOTk5IiBmb250LXNpemU9IjE0IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+5Zu+54mH5Yqg6L295aSx6LSlPC90ZXh0Pjwvc3ZnPg=='">
                        </div>
                        <div class="file-name" title="${image.name}">${image.name}</div>
                        <div class="file-size">${this.formatFileSize(image.size)}</div>
                    </div>
                `).join('');

                fileGrid.innerHTML = foldersHtml + imagesHtml;

                this.bindFileEvents();

                // Force override CSS constraints after DOM update
                setTimeout(() => {
                    this.forceImageStyles();
                    this.forcePageRerender();
                }, 100);

                console.log(`âœ… æ¸²æŸ“äº† ${subFolders.length} ä¸ªæ–‡ä»¶å¤¹å’Œ ${currentImages.length} å¼ å›¾ç‰‡`);
            }

            // è·å–å½“å‰æ–‡ä»¶å¤¹çš„å›¾ç‰‡
            getCurrentFolderImages() {
                if (this.isRootView()) {
                    // æ ¹ç›®å½•å±•ç¤ºæ‰€æœ‰æœªç»‘å®šæ–‡ä»¶å¤¹çš„å›¾ç‰‡
                    return this.images.filter(image => !image.folderId || image.folderId === 'all');
                }

                // åœ¨ç‰¹å®šæ–‡ä»¶å¤¹å†…åªæ˜¾ç¤ºå±äºè¯¥æ–‡ä»¶å¤¹çš„å›¾ç‰‡
                return this.images.filter(image => image.folderId === this.currentFolderId);
            }

            // è·å–å½“å‰æ–‡ä»¶å¤¹çš„å­æ–‡ä»¶å¤¹
            getCurrentSubFolders() {
                if (this.isRootView()) {
                    // åœ¨æ ¹ç›®å½•æ˜¾ç¤ºæ‰€æœ‰é¡¶çº§æ–‡ä»¶å¤¹
                    return Array.from(this.folders.values()).filter(folder =>
                        !folder.isSystem && (folder.parentFolder === 'root' || !folder.parentFolder)
                    );
                } else if (this.currentFolderId && this.currentFolderId !== 'recent' && this.currentFolderId !== 'favorites') {
                    // åœ¨ç‰¹å®šæ–‡ä»¶å¤¹ä¸­æ˜¾ç¤ºå­æ–‡ä»¶å¤¹
                    return Array.from(this.folders.values()).filter(folder =>
                        folder.parentFolder === this.currentFolderId
                    );
                }
                return [];
            }

            bindFileEvents() {
                // ç»‘å®šæ–‡ä»¶å¤¹ç‚¹å‡»äº‹ä»¶
                const folderItems = document.querySelectorAll('.folder-item');
                folderItems.forEach(item => {
                    item.addEventListener('dblclick', () => {
                        const folderId = item.dataset.folderId;
                        this.navigateToFolder(folderId);
                    });

                    item.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        const folderId = item.dataset.folderId;
                        this.showFolderContextMenu(e, folderId);
                    });
                });

                // ç»‘å®šå›¾ç‰‡ç‚¹å‡»äº‹ä»¶
                const imageItems = document.querySelectorAll('.image-item');
                imageItems.forEach(item => {
                    item.addEventListener('click', () => {
                        const imageId = item.dataset.imageId;
                        const image = this.images.find(img => img.id === imageId);
                        if (image) {
                            window.open(image.url, '_blank');
                        }
                    });

                    item.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        this.showContextMenu(e, item.dataset.imageId);
                    });
                });
            }

            // ä¼˜åŒ–å›¾ç‰‡æ ·å¼åº”ç”¨ - å‡å°‘DOMæ“ä½œ
            forceImageStyles() {
                console.log('ğŸ¨ ä¼˜åŒ–åº”ç”¨å›¾ç‰‡æ ·å¼...');

                // æ‰¹é‡å¤„ç†ï¼Œå‡å°‘é‡ç»˜
                const images = document.querySelectorAll('.file-icon.image img');
                const containers = document.querySelectorAll('.file-icon.image');

                // ä½¿ç”¨requestAnimationFrameä¼˜åŒ–æ€§èƒ½
                requestAnimationFrame(() => {
                    images.forEach((img, index) => {
                        // ä½¿ç”¨cssTextä¸€æ¬¡æ€§è®¾ç½®æ‰€æœ‰æ ·å¼
                        img.style.cssText += 'width: 100% !important; height: 120px !important; max-width: none !important; max-height: none !important; min-width: 120px !important; min-height: 120px !important; object-fit: cover !important; border-radius: 8px !important; display: block !important;';
                        console.log(`âœ… åº”ç”¨æ ·å¼åˆ°å›¾ç‰‡ ${index + 1}: 120x120`);
                    });

                    containers.forEach((container, index) => {
                        // ä½¿ç”¨cssTextä¸€æ¬¡æ€§è®¾ç½®æ‰€æœ‰æ ·å¼
                        container.style.cssText += 'width: 100% !important; height: 120px !important; display: flex !important; align-items: center !important; justify-content: center !important; overflow: hidden !important; border-radius: 8px !important; background: #f0f0f0 !important;';
                        console.log(`âœ… åº”ç”¨å®¹å™¨æ ·å¼ ${index + 1}`);
                    });

                    console.log('ğŸ¨ å›¾ç‰‡æ ·å¼ä¼˜åŒ–åº”ç”¨å®Œæˆ');
                });
            }

            // å¼ºåˆ¶é¡µé¢é‡æ–°æ¸²æŸ“ - è§£å†³æµè§ˆå™¨æ¸²æŸ“é—®é¢˜
            forcePageRerender() {
                console.log('ğŸ”„ å¼ºåˆ¶é¡µé¢é‡æ–°æ¸²æŸ“...');

                const fileArea = document.querySelector('.file-area');
                const fileGrid = document.getElementById('fileGrid');

                if (fileArea && fileGrid) {
                    // æ–¹æ³•1: å¼ºåˆ¶é‡æ’
                    fileArea.style.display = 'none';
                    fileArea.offsetHeight; // è§¦å‘é‡æ’
                    fileArea.style.display = 'block';

                    // æ–¹æ³•2: å¼ºåˆ¶é‡ç»˜
                    fileGrid.style.transform = 'translateZ(0)';
                    fileGrid.style.willChange = 'transform';

                    // æ–¹æ³•3: æ·»åŠ å¯è§æ€§å¼ºåˆ¶
                    fileGrid.style.setProperty('visibility', 'visible', 'important');
                    fileGrid.style.setProperty('opacity', '1', 'important');
                    fileGrid.style.setProperty('display', 'grid', 'important');

                    // ä¼˜åŒ–å¸ƒå±€è®¡ç®— - å‡å°‘å»¶è¿Ÿ
                    requestAnimationFrame(() => {
                        fileGrid.style.cssText += 'grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)) !important; gap: 20px !important; padding: 20px !important;';

                        // æ‰¹é‡å¤„ç†æ–‡ä»¶é¡¹
                        const fileItems = document.querySelectorAll('.file-item');
                        fileItems.forEach((item, index) => {
                            if (item.style.display === 'none' || !item.style.visibility) {
                                item.style.cssText += 'display: flex !important; visibility: visible !important; opacity: 1 !important;';
                                console.log(`âœ… å¼ºåˆ¶æ˜¾ç¤ºæ–‡ä»¶é¡¹ ${index + 1}`);
                            }
                        });

                        console.log('ğŸ”„ é¡µé¢æ¸²æŸ“ä¼˜åŒ–å®Œæˆ');
                    });
                }
            }

            removeExistingContextMenu() {
                const existingMenu = document.querySelector('.context-menu');
                if (existingMenu) {
                    existingMenu.remove();
                }
            }

            showContextMenu(e, imageId) {
                const image = this.images.find(img => img.id === imageId);
                if (!image) return;

                this.removeExistingContextMenu();

                // åˆ›å»ºæ–°çš„èœå•
                const contextMenu = document.createElement('div');
                contextMenu.className = 'context-menu';
                contextMenu.id = 'contextMenu'; // ç¡®ä¿IDå­˜åœ¨ä»¥ä¾¿CSSé€‰æ‹©å™¨å·¥ä½œ
                
                contextMenu.innerHTML = `
                    <div class="context-menu-item" data-action="copy">
                        <i class="fas fa-link"></i> å¤åˆ¶é“¾æ¥
                    </div>
                    <div class="context-menu-item" data-action="download">
                        <i class="fas fa-download"></i> ä¸‹è½½å›¾ç‰‡
                    </div>
                    <div class="context-menu-separator"></div>
                    <div class="context-menu-item danger" data-action="delete">
                        <i class="fas fa-trash"></i> åˆ é™¤å›¾ç‰‡
                    </div>
                `;

                document.body.appendChild(contextMenu);
                
                // å®šä½èœå•
                contextMenu.style.left = `${e.pageX}px`;
                contextMenu.style.top = `${e.pageY}px`;
                contextMenu.classList.add('show');

                // ç¡®ä¿èœå•åœ¨å±å¹•å†…
                const rect = contextMenu.getBoundingClientRect();
                if (rect.right > window.innerWidth) {
                    contextMenu.style.left = `${e.pageX - rect.width}px`;
                }
                if (rect.bottom > window.innerHeight) {
                    contextMenu.style.top = `${e.pageY - rect.height}px`;
                }

                // ç»‘å®šäº‹ä»¶
                contextMenu.querySelectorAll('.context-menu-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const action = item.dataset.action;
                        this.handleContextMenuAction(action, image, imageId);
                        contextMenu.remove();
                    });
                });

                // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­
                setTimeout(() => {
                    document.addEventListener('click', () => contextMenu.remove(), { once: true });
                }, 0);
            }

            handleContextMenuAction(action, image, imageId) {
                switch(action) {
                    case 'copy':
                        this.copyToClipboard(window.location.origin + image.url);
                        break;
                    case 'download':
                        this.downloadImage(image);
                        break;
                    case 'delete':
                        this.deleteImage(imageId);
                        break;
                }
            }

            showFolderContextMenu(e, folderId) {
                const folder = this.folders.get(folderId);
                if (!folder || folder.isSystem) return;

                this.removeExistingContextMenu();

                const contextMenu = document.createElement('div');
                contextMenu.className = 'context-menu';
                contextMenu.id = 'folderContextMenu';

                contextMenu.innerHTML = `
                    <div class="context-menu-item" data-action="open">
                        <i class="fas fa-folder-open"></i> æ‰“å¼€æ–‡ä»¶å¤¹
                    </div>
                    <div class="context-menu-item danger" data-action="delete">
                        <i class="fas fa-trash"></i> åˆ é™¤æ–‡ä»¶å¤¹
                    </div>
                `;

                document.body.appendChild(contextMenu);

                contextMenu.style.left = `${e.pageX}px`;
                contextMenu.style.top = `${e.pageY}px`;
                contextMenu.classList.add('show');

                const rect = contextMenu.getBoundingClientRect();
                if (rect.right > window.innerWidth) {
                    contextMenu.style.left = `${e.pageX - rect.width}px`;
                }
                if (rect.bottom > window.innerHeight) {
                    contextMenu.style.top = `${e.pageY - rect.height}px`;
                }

                contextMenu.querySelectorAll('.context-menu-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const action = item.dataset.action;
                        this.handleFolderContextMenuAction(action, folder);
                        contextMenu.remove();
                    });
                });

                setTimeout(() => {
                    document.addEventListener('click', () => this.removeExistingContextMenu(), { once: true });
                }, 0);
            }

            handleFolderContextMenuAction(action, folder) {
                switch (action) {
                    case 'open':
                        this.navigateToFolder(folder.id);
                        break;
                    case 'delete':
                        this.deleteFolder(folder);
                        break;
                }
            }

            async deleteFolder(folder) {
                if (!folder || folder.isSystem) return;

                const confirmMessage = `ç¡®å®šè¦åˆ é™¤æ–‡ä»¶å¤¹ "${folder.name}" å—ï¼Ÿ\nå…¶ä¸­çš„å›¾ç‰‡å°†ç§»åŠ¨åˆ°æ ¹ç›®å½•ã€‚`;
                if (!confirm(confirmMessage)) {
                    return;
                }

                try {
                    this.showNotification(`æ­£åœ¨åˆ é™¤æ–‡ä»¶å¤¹ "${folder.name}"...`, 'info');

                    const response = await fetch(`/api/manage/folders-enhanced?id=${encodeURIComponent(folder.id)}`, {
                        method: 'DELETE'
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.error || 'åˆ é™¤å¤±è´¥');
                    }

                    // ä»æœ¬åœ°çŠ¶æ€ä¸­ç§»é™¤æ–‡ä»¶å¤¹ï¼Œå¹¶æ¸…é™¤ç¼“å­˜
                    this.folders.delete(folder.id);
                    localStorage.removeItem('telegraph_folders_cache');

                    // å¦‚æœå½“å‰æ­£åœ¨æµè§ˆè¢«åˆ é™¤çš„æ–‡ä»¶å¤¹ï¼Œåˆ™é€€å›æ ¹ç›®å½•
                    if (this.currentFolderId === folder.id) {
                        this.currentFolderId = 'all';
                        this.currentPath = '/';
                    }

                    this.savePageState();

                    // é‡æ–°æ‹‰å–æ–‡ä»¶å¤¹å’Œå›¾ç‰‡æ•°æ®
                    await this.loadFolders(true);
                    await this.loadImages(true);

                    this.renderSidebar();
                    this.renderImages();
                    this.updateBreadcrumb();
                    this.updateActiveNavigation();

                    this.showNotification(`æ–‡ä»¶å¤¹ "${folder.name}" å·²åˆ é™¤`, 'success');
                } catch (error) {
                    console.error('åˆ é™¤æ–‡ä»¶å¤¹å¤±è´¥:', error);
                    this.showNotification(`åˆ é™¤æ–‡ä»¶å¤¹å¤±è´¥ï¼š${error.message}`, 'error');
                }
            }

            copyToClipboard(text) {
                navigator.clipboard.writeText(text).then(() => {
                    alert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
                }).catch(() => {
                    prompt('è¯·æ‰‹åŠ¨å¤åˆ¶é“¾æ¥:', text);
                });
            }

            downloadImage(image) {
                const a = document.createElement('a');
                a.href = image.url;
                a.download = image.name;
                a.click();
            }

            async deleteImage(imageId) {
                const image = this.images.find(img => img.id === imageId);
                if (!image) return;

                if (!confirm(`ç¡®å®šè¦åˆ é™¤å›¾ç‰‡ "${image.name}" å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) return;

                console.log('ğŸ—‘ï¸ å¼€å§‹åˆ é™¤å›¾ç‰‡:', imageId);

                try {
                    const response = await fetch(`/api/manage/delete/${imageId}`, {
                        method: 'DELETE',
                        headers: {
                            'Cache-Control': 'no-cache',
                            'Pragma': 'no-cache'
                        }
                    });

                    if (response.ok) {
                        console.log('âœ… æœåŠ¡å™¨åˆ é™¤æˆåŠŸ');

                        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                        this.showSuccessMessage(`å›¾ç‰‡ "${image.name}" åˆ é™¤æˆåŠŸï¼`);

                        // ç­‰å¾…1ç§’ç¡®ä¿æœåŠ¡å™¨å¤„ç†å®Œæˆ
                        await new Promise(resolve => setTimeout(resolve, 1000));

                        // å¼ºåˆ¶ä»æœåŠ¡å™¨é‡æ–°åŠ è½½å›¾ç‰‡åˆ—è¡¨
                        await this.loadImages(true);
                        this.renderImages();
                        this.renderSidebar();

                        console.log('ğŸ”„ å›¾ç‰‡åˆ—è¡¨å·²åˆ·æ–°');
                    } else {
                        const errorText = await response.text();
                        console.error('âŒ åˆ é™¤å¤±è´¥:', response.status, errorText);
                        alert(`åˆ é™¤å¤±è´¥: ${response.status} ${errorText}`);
                    }
                } catch (error) {
                    console.error('âŒ åˆ é™¤å¼‚å¸¸:', error);
                    alert('åˆ é™¤å¤±è´¥ï¼š' + error.message);
                }
            }

            handleFileUpload(files) {
                if (!files || files.length === 0) return;

                const validFiles = Array.from(files).filter(file => {
                    if (this.isImageFile(file.name)) {
                        // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æ–‡ä»¶å¤§å°æ ¡éªŒ
                        return true;
                    }
                    this.showNotification(`${file.name} (ä¸æ”¯æŒçš„æ ¼å¼)`, 'warning');
                    return false;
                });

                if (validFiles.length === 0) {
                    this.showNotification('æ²¡æœ‰æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶å¯ä¸Šä¼ ', 'error');
                    return;
                }

                // ä½¿ç”¨åå°ä¸Šä¼ 
                for (let file of validFiles) {
                    this.createBackgroundUploadTask(file);
                }
            }

            createBackgroundUploadTask(file) {
                const container = document.getElementById('backgroundUploadContainer');
                const taskId = 'upload_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                
                const taskElement = document.createElement('div');
                taskElement.className = 'upload-task';
                taskElement.id = taskId;
                taskElement.innerHTML = `
                    <div class="upload-task-header">
                        <div class="upload-task-info">
                            <div class="upload-task-name" title="${file.name}">${file.name}</div>
                            <div class="upload-task-status">å‡†å¤‡ä¸Šä¼ ...</div>
                        </div>
                        <button class="upload-task-close" onclick="imageViewer.cancelUploadTask('${taskId}')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="upload-progress-bar">
                        <div class="upload-progress-fill" style="width: 0%"></div>
                    </div>
                `;
                
                container.appendChild(taskElement);
                
                // å¼€å§‹ä¸Šä¼ 
                this.performBackgroundUpload(file, taskId);
            }

            async performBackgroundUpload(file, taskId) {
                const taskElement = document.getElementById(taskId);
                if (!taskElement) return;

                const statusElement = taskElement.querySelector('.upload-task-status');
                const progressFill = taskElement.querySelector('.upload-progress-fill');
                
                try {
                    statusElement.textContent = 'ä¸Šä¼ ä¸­...';
                    
                    // ä¼˜åŒ–è¿›åº¦æ¡åŠ¨ç”» - å‡å°‘å»¶è¿Ÿ
                    for (let i = 0; i <= 90; i += 15) {
                        await new Promise(resolve => setTimeout(resolve, 50));
                        if (!document.getElementById(taskId)) return; // ä»»åŠ¡å¯èƒ½å·²è¢«å–æ¶ˆ
                        progressFill.style.width = i + '%';
                        statusElement.textContent = `ä¸Šä¼ ä¸­... ${i}%`;
                    }

                    const formData = new FormData();
                    formData.append('file', file);

                    // æ·»åŠ å½“å‰æ–‡ä»¶å¤¹ID
                    if (this.currentFolderId && this.currentFolderId !== 'all') {
                        formData.append('folderId', this.currentFolderId);
                        formData.append('parentFolder', this.currentFolderId);
                    }

                    const response = await fetch('/upload', {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        progressFill.style.width = '100%';
                        statusElement.textContent = 'ä¸Šä¼ å®Œæˆ';
                        taskElement.classList.add('success');
                        
                        this.showNotification(`${file.name} ä¸Šä¼ æˆåŠŸï¼`, 'success');
                        
                        setTimeout(async () => {
                            await this.loadImages(true);
                            this.renderImages();
                            this.renderSidebar();
                        }, 1000);
                        
                    } else {
                        throw new Error(`HTTP ${response.status}`);
                    }

                } catch (error) {
                    if (!document.getElementById(taskId)) return;
                    progressFill.style.width = '100%';
                    statusElement.textContent = 'ä¸Šä¼ å¤±è´¥';
                    taskElement.classList.add('error');
                    this.showNotification(`${file.name} ä¸Šä¼ å¤±è´¥: ${error.message}`, 'error');
                }
                
                // 3ç§’åè‡ªåŠ¨ç§»é™¤ä»»åŠ¡
                setTimeout(() => {
                    if (taskElement) {
                        taskElement.classList.add('completed');
                        setTimeout(() => taskElement.remove(), 300);
                    }
                }, 3000);
            }

            cancelUploadTask(taskId) {
                const taskElement = document.getElementById(taskId);
                if (taskElement) {
                    taskElement.remove();
                    this.showNotification('ä¸Šä¼ å·²å–æ¶ˆ', 'info');
                }
            }

            // æ˜¾ç¤ºé€šçŸ¥
            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: ${type === 'success' ? '#34c759' : type === 'error' ? '#ff3b30' : type === 'warning' ? '#ff9500' : '#007aff'};
                    color: white;
                    padding: 12px 16px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    z-index: 1000;
                    max-width: 300px;
                    word-wrap: break-word;
                `;
                notification.textContent = message;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 4000);
            }

            showSuccessMessage(message) {
                this.showNotification(message, 'success');
            }

            formatFileSize(bytes) {
                if (bytes === 0) return '0 B';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            // åŠ è½½æ–‡ä»¶å¤¹åˆ—è¡¨
            async loadFolders(forceRefresh = false) {
                console.log('ğŸ“ åŠ è½½æ–‡ä»¶å¤¹åˆ—è¡¨...', forceRefresh ? '(å¼ºåˆ¶åˆ·æ–°)' : '(å®æ—¶åŒæ­¥)');

                const fallbackToCache = () => {
                    const cachedFolders = this.loadFoldersFromCache();
                    if (cachedFolders && cachedFolders.length > 0) {
                        this.hydrateFolders(cachedFolders);
                        console.log(`âœ… ä»ç¼“å­˜æ¢å¤ ${cachedFolders.length} ä¸ªæ–‡ä»¶å¤¹`);
                        return true;
                    }
                    return false;
                };

                const cacheBuster = `?t=${Date.now()}`;

                try {
                    const response = await fetch(`/api/manage/folders-enhanced${cacheBuster}`);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }

                    const folders = await response.json();
                    const normalizedFolders = Array.isArray(folders) ? folders : [];

                    this.hydrateFolders(normalizedFolders);
                    this.saveFoldersToCache(normalizedFolders);
                    console.log(`âœ… åŒæ­¥ ${normalizedFolders.length} ä¸ªæ–‡ä»¶å¤¹`);
                } catch (error) {
                    console.error('ğŸ“ è·å–æœåŠ¡å™¨æ–‡ä»¶å¤¹å¤±è´¥:', error);

                    if (!fallbackToCache()) {
                        console.log('ğŸ“ ä½¿ç”¨é»˜è®¤æ–‡ä»¶å¤¹');
                        this.initDefaultFolders();
                    }
                }
            }

            // ä»ç¼“å­˜åŠ è½½æ–‡ä»¶å¤¹
            loadFoldersFromCache() {
                try {
                    const cached = localStorage.getItem('telegraph_folders_cache');
                    if (cached) {
                        const data = JSON.parse(cached);
                        // æ£€æŸ¥ç¼“å­˜æ˜¯å¦è¿‡æœŸï¼ˆ5åˆ†é’Ÿï¼‰
                        if (Date.now() - data.timestamp < 5 * 60 * 1000) {
                            return data.folders;
                        }
                    }
                } catch (error) {
                    console.error('åŠ è½½æ–‡ä»¶å¤¹ç¼“å­˜å¤±è´¥:', error);
                }
                return null;
            }

            // ä¿å­˜æ–‡ä»¶å¤¹åˆ°ç¼“å­˜
            saveFoldersToCache(folders) {
                try {
                    localStorage.setItem('telegraph_folders_cache', JSON.stringify({
                        timestamp: Date.now(),
                        folders: folders
                    }));
                } catch (error) {
                    console.error('ä¿å­˜æ–‡ä»¶å¤¹ç¼“å­˜å¤±è´¥:', error);
                }
            }

            // æ„å»ºç³»ç»Ÿæ–‡ä»¶å¤¹åŸºç¡€æ•°æ®
            prepareSystemFolders() {
                this.folders.clear();

                const systemFolders = [
                    { id: 'all', name: 'å…¨éƒ¨å›¾ç‰‡', icon: 'fas fa-images', isSystem: true },
                    { id: 'recent', name: 'æœ€è¿‘ä½¿ç”¨', icon: 'fas fa-clock', isSystem: true },
                    { id: 'favorites', name: 'æ”¶è—å¤¹', icon: 'fas fa-star', isSystem: true }
                ];

                systemFolders.forEach(folder => {
                    this.folders.set(folder.id, {
                        fileCount: 0,
                        ...folder
                    });
                });
            }

            hydrateFolders(folders = []) {
                this.prepareSystemFolders();

                folders.forEach(folder => {
                    if (!folder || !folder.id) return;

                    if (folder.isSystem && this.folders.has(folder.id)) {
                        this.folders.set(folder.id, {
                            ...this.folders.get(folder.id),
                            ...folder,
                            fileCount: folder.fileCount ?? this.folders.get(folder.id).fileCount ?? 0
                        });
                    } else {
                        this.folders.set(folder.id, {
                            fileCount: folder.fileCount ?? 0,
                            ...folder,
                            isSystem: Boolean(folder.isSystem)
                        });
                    }
                });

                this.updateFolderCounts();
                this.updateActiveNavigation();
            }

            // åˆå§‹åŒ–é»˜è®¤æ–‡ä»¶å¤¹
            initDefaultFolders() {
                this.prepareSystemFolders();
                this.updateFolderCounts();
                this.updateActiveNavigation();
            }

            // æ¸²æŸ“ä¾§è¾¹æ 
            renderSidebar() {
                const customFoldersList = document.getElementById('customFoldersList');
                if (!customFoldersList) return;

                const customFolders = Array.from(this.folders.values()).filter(folder => !folder.isSystem);

                if (customFolders.length === 0) {
                    customFoldersList.innerHTML = '<li style="padding: 8px 16px; color: #999; font-size: 12px;">æš‚æ— è‡ªå®šä¹‰æ–‡ä»¶å¤¹</li>';
                } else {
                    customFoldersList.innerHTML = customFolders.map(folder => `
                        <li class="nav-item" data-path="${folder.id}" data-folder-type="custom">
                            <i class="fas fa-folder" style="color: ${folder.color || '#4A90E2'};"></i>
                            <span>${folder.name}</span>
                            <span class="folder-count">${folder.fileCount || 0}</span>
                        </li>
                    `).join('');

                    // ç»‘å®šç‚¹å‡»äº‹ä»¶
                    customFoldersList.querySelectorAll('.nav-item').forEach(item => {
                        item.addEventListener('click', () => {
                            this.navigateToFolder(item.dataset.path);
                        });

                        item.addEventListener('contextmenu', (e) => {
                            e.preventDefault();
                            this.showFolderContextMenu(e, item.dataset.path);
                        });
                    });
                }

                this.updateActiveNavigation();
            }

            // æ˜¾ç¤ºæ–°å»ºæ–‡ä»¶å¤¹æ¨¡æ€æ¡†
            showNewFolderModal() {
                const modal = document.getElementById('newFolderModal');
                const nameInput = document.getElementById('folderNameInput');
                const colorInput = document.getElementById('folderColorInput');
                const cancelBtn = document.getElementById('cancelFolderBtn');
                const createBtn = document.getElementById('createFolderBtn');
                const closeBtn = document.getElementById('modalCloseBtn');

                // é‡ç½®è¡¨å•
                nameInput.value = '';
                colorInput.value = '#4A90E2';
                nameInput.style.borderColor = '#e1e5e9';

                modal.classList.add('show');
                nameInput.focus();

                // ç§»é™¤ä¹‹å‰çš„äº‹ä»¶ç›‘å¬å™¨
                const newCancelBtn = cancelBtn.cloneNode(true);
                const newCreateBtn = createBtn.cloneNode(true);
                const newCloseBtn = closeBtn.cloneNode(true);
                cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
                createBtn.parentNode.replaceChild(newCreateBtn, createBtn);
                closeBtn.parentNode.replaceChild(newCloseBtn, closeBtn);

                // ç»‘å®šå…³é—­æŒ‰é’®
                newCloseBtn.addEventListener('click', () => {
                    this.closeFolderModal();
                });

                // ç»‘å®šå–æ¶ˆæŒ‰é’®
                newCancelBtn.addEventListener('click', () => {
                    this.closeFolderModal();
                });

                // ç»‘å®šåˆ›å»ºæŒ‰é’®
                newCreateBtn.addEventListener('click', () => {
                    this.createNewFolder();
                });

                // ç»‘å®šé¢œè‰²é¢„è®¾ç‚¹å‡»äº‹ä»¶
                document.querySelectorAll('.color-preset').forEach(preset => {
                    preset.addEventListener('click', () => {
                        const color = preset.dataset.color;
                        colorInput.value = color;
                        document.querySelectorAll('.color-preset').forEach(p => p.classList.remove('selected'));
                        preset.classList.add('selected');
                    });
                });

                // ç»‘å®šå›è½¦é”®åˆ›å»º
                const handleKeyPress = (e) => {
                    if (e.key === 'Enter') {
                        this.createNewFolder();
                    } else if (e.key === 'Escape') {
                        this.closeFolderModal();
                    }
                };
                nameInput.removeEventListener('keypress', handleKeyPress);
                nameInput.addEventListener('keypress', handleKeyPress);
            }

            // å…³é—­æ–‡ä»¶å¤¹æ¨¡æ€æ¡†
            closeFolderModal() {
                const modal = document.getElementById('newFolderModal');
                modal.classList.remove('show');
            }

            // å¯¼èˆªåˆ°æ–‡ä»¶å¤¹
            navigateToFolder(folderId) {
                console.log('ğŸ“ å¯¼èˆªåˆ°æ–‡ä»¶å¤¹:', folderId);
                this.currentFolderId = folderId;
                this.currentPath = folderId === 'all' ? '/' : folderId;

                // ä¿å­˜é¡µé¢çŠ¶æ€
                this.savePageState();

                this.updateActiveNavigation();

                // é‡æ–°åŠ è½½å’Œæ¸²æŸ“å›¾ç‰‡
                this.loadImages(true).then(() => {
                    this.renderImages();
                    this.renderSidebar();
                    this.updateActiveNavigation();
                });

                // æ›´æ–°é¢åŒ…å±‘
                this.updateBreadcrumb();
            }

            // æ›´æ–°é¢åŒ…å±‘å¯¼èˆª
            updateBreadcrumb() {
                const breadcrumb = document.getElementById('breadcrumb');
                if (!breadcrumb) return;

                let breadcrumbHtml = '';
                if (this.currentFolderId === 'all' || this.currentPath === '/') {
                    breadcrumbHtml = '<span class="breadcrumb-item">å…¨éƒ¨å›¾ç‰‡</span>';
                } else {
                    const folder = this.folders.get(this.currentFolderId);
                    if (folder) {
                        breadcrumbHtml = `
                            <span class="breadcrumb-item" onclick="imageViewer.navigateToFolder('all')">å…¨éƒ¨å›¾ç‰‡</span>
                            <span class="breadcrumb-separator">/</span>
                            <span class="breadcrumb-item">${folder.name}</span>
                        `;
                    }
                }
                breadcrumb.innerHTML = breadcrumbHtml;
            }

            updateActiveNavigation() {
                const systemPathMap = {
                    all: '/',
                    recent: '/recent',
                    favorites: '/favorites'
                };

                const expectedSystemPath = systemPathMap[this.currentFolderId] || '/';

                document.querySelectorAll('.nav-item[data-folder-type="system"]').forEach(item => {
                    item.classList.toggle('active', item.dataset.path === expectedSystemPath);
                });

                document.querySelectorAll('.nav-item[data-folder-type="custom"]').forEach(item => {
                    item.classList.toggle('active', item.dataset.path === this.currentFolderId);
                });
            }

            updateFolderCounts() {
                if (!(this.folders instanceof Map)) {
                    this.folders = new Map();
                }

                if (this.folders.size === 0) {
                    this.prepareSystemFolders();
                }

                const images = Array.isArray(this.images) ? this.images : [];
                const folderCounts = new Map();
                const weekAgo = Date.now() - 7 * 24 * 60 * 60 * 1000;

                let recentCount = 0;
                let favoritesCount = 0;

                images.forEach(image => {
                    const uploadTime = image.uploadDate instanceof Date
                        ? image.uploadDate.getTime()
                        : Number(image.uploadDate) || 0;

                    if (uploadTime && uploadTime > weekAgo) {
                        recentCount++;
                    }

                    if (image.liked) {
                        favoritesCount++;
                    }

                    const folderKey = image.folderId || 'root';
                    folderCounts.set(folderKey, (folderCounts.get(folderKey) || 0) + 1);
                });

                const allFolder = this.folders.get('all');
                if (allFolder) {
                    allFolder.fileCount = images.length;
                }

                const recentFolder = this.folders.get('recent');
                if (recentFolder) {
                    recentFolder.fileCount = recentCount;
                }

                const favoritesFolder = this.folders.get('favorites');
                if (favoritesFolder) {
                    favoritesFolder.fileCount = favoritesCount;
                }

                this.folders.forEach(folder => {
                    if (folder.isSystem) return;
                    folder.fileCount = folderCounts.get(folder.id) || 0;
                });
            }

            // åˆ›å»ºæ–°æ–‡ä»¶å¤¹
            async createNewFolder() {
                const nameInput = document.getElementById('folderNameInput');
                const colorInput = document.getElementById('folderColorInput');
                const createBtn = document.querySelector('.btn-primary');

                const name = nameInput.value.trim();
                if (!name) {
                    nameInput.style.borderColor = '#dc3545';
                    nameInput.focus();
                    this.showNotification('è¯·è¾“å…¥æ–‡ä»¶å¤¹åç§°', 'error');
                    return;
                }

                // æ£€æŸ¥åç§°é•¿åº¦
                if (name.length > 50) {
                    nameInput.style.borderColor = '#dc3545';
                    this.showNotification('æ–‡ä»¶å¤¹åç§°ä¸èƒ½è¶…è¿‡50ä¸ªå­—ç¬¦', 'error');
                    return;
                }

                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨åŒåæ–‡ä»¶å¤¹
                const existingFolder = Array.from(this.folders.values()).find(f =>
                    f.name === name && f.parentFolder === (this.currentFolderId || 'root')
                );
                if (existingFolder) {
                    nameInput.style.borderColor = '#dc3545';
                    this.showNotification('è¯¥æ–‡ä»¶å¤¹åç§°å·²å­˜åœ¨', 'error');
                    return;
                }

                // é‡ç½®è¾“å…¥æ¡†æ ·å¼
                nameInput.style.borderColor = '#e1e5e9';

                // æ˜¾ç¤ºåˆ›å»ºä¸­çŠ¶æ€
                const originalText = createBtn.textContent;
                createBtn.textContent = 'åˆ›å»ºä¸­...';
                createBtn.disabled = true;

                try {
                    // æ£€æŸ¥æ˜¯å¦ä¸ºæœ¬åœ°å¼€å‘ç¯å¢ƒ
                    const isLocalDev = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';

                    if (isLocalDev) {
                        // æœ¬åœ°å¼€å‘ç¯å¢ƒï¼šæ¨¡æ‹ŸæˆåŠŸåˆ›å»ºæ–‡ä»¶å¤¹
                        await new Promise(resolve => setTimeout(resolve, 1000)); // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ

                        const newFolder = {
                            id: 'folder_' + Date.now(),
                            name: name,
                            color: colorInput.value,
                            parentFolder: this.currentFolderId === 'all' ? 'root' : (this.currentFolderId || 'root'),
                            fileCount: 0,
                            createdAt: new Date().toISOString()
                        };

                        this.folders.set(newFolder.id, newFolder);

                        // ä¿å­˜æ–°çš„æ–‡ä»¶å¤¹åˆ°ç¼“å­˜
                        this.saveFoldersToCache(Array.from(this.folders.values()));

                        this.renderSidebar();
                        this.showNotification(`æ–‡ä»¶å¤¹ "${name}" åˆ›å»ºæˆåŠŸï¼ï¼ˆæœ¬åœ°æ¼”ç¤ºæ¨¡å¼ï¼‰`, 'success');
                        this.closeFolderModal();
                    } else {
                        // ç”Ÿäº§ç¯å¢ƒï¼šè°ƒç”¨çœŸå®API
                        const response = await fetch('/api/manage/folders-enhanced', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                name: name,
                                color: colorInput.value,
                                parentFolder: this.currentFolderId === 'all' ? 'root' : (this.currentFolderId || 'root')
                            })
                        });

                        if (response.ok) {
                            const newFolder = await response.json();
                            this.folders.set(newFolder.id, newFolder);

                            // æ¸…é™¤æ–‡ä»¶å¤¹ç¼“å­˜ï¼Œå¼ºåˆ¶åˆ·æ–°
                            localStorage.removeItem('telegraph_folders_cache');

                            this.renderSidebar();
                            this.showNotification(`æ–‡ä»¶å¤¹ "${name}" åˆ›å»ºæˆåŠŸï¼`, 'success');
                            this.closeFolderModal();
                        } else {
                            const error = await response.json();
                            this.showNotification('åˆ›å»ºå¤±è´¥ï¼š' + (error.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                        }
                    }
                } catch (error) {
                    console.error('åˆ›å»ºæ–‡ä»¶å¤¹å¤±è´¥:', error);
                    this.showNotification('åˆ›å»ºå¤±è´¥ï¼šç½‘ç»œè¿æ¥é”™è¯¯', 'error');
                } finally {
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    createBtn.textContent = originalText;
                    createBtn.disabled = false;
                }
            }
        }

        // å¯åŠ¨åº”ç”¨
        window.imageViewer = new SimpleImageViewer();

        // å…¨å±€è·¯ç”±æ£€æŸ¥å‡½æ•°
        window.checkUrlRouting = function() {
            const path = window.location.pathname;
            const hash = window.location.hash;

            console.log('ğŸ”— å…¨å±€è·¯ç”±æ£€æŸ¥:', path, hash);

            // æ£€æŸ¥æ˜¯å¦æ˜¯æ–°å»ºæ–‡ä»¶å¤¹è·¯ç”±
            if (path.includes('/finder/new') || hash === '#new') {
                console.log('ğŸ“ æ£€æµ‹åˆ°æ–°å»ºæ–‡ä»¶å¤¹è·¯ç”±ï¼Œè‡ªåŠ¨æ‰“å¼€æ–°å»ºæ–‡ä»¶å¤¹æ¨¡æ€æ¡†');

                // æŸ¥æ‰¾æ–°å»ºæ–‡ä»¶å¤¹æŒ‰é’®å¹¶ç‚¹å‡»
                const newFolderBtn = document.getElementById('newFolderBtn');
                if (newFolderBtn) {
                    newFolderBtn.click();
                    console.log('âœ… å·²ç‚¹å‡»æ–°å»ºæ–‡ä»¶å¤¹æŒ‰é’®');
                } else {
                    console.log('âŒ æ‰¾ä¸åˆ°æ–°å»ºæ–‡ä»¶å¤¹æŒ‰é’®');
                }

                // æ¸…é™¤URLä¸­çš„è·¯ç”±æ ‡è¯†
                if (path.includes('/finder/new')) {
                    window.history.replaceState({}, '', '/finder/');
                } else if (hash === '#new') {
                    window.history.replaceState({}, '', window.location.pathname);
                }
            }
        };

        // é¡µé¢åŠ è½½å®Œæˆåæ£€æŸ¥è·¯ç”±
        setTimeout(() => {
            const hash = window.location.hash;
            const path = window.location.pathname;

            console.log('ğŸ”— æ£€æŸ¥URLè·¯ç”±:', path, hash);

            // æ£€æŸ¥æ˜¯å¦æ˜¯æ–°å»ºæ–‡ä»¶å¤¹è·¯ç”±
            if (path.includes('/finder/new') || hash === '#new') {
                console.log('ğŸ“ æ£€æµ‹åˆ°æ–°å»ºæ–‡ä»¶å¤¹è·¯ç”±ï¼Œè‡ªåŠ¨ç‚¹å‡»æ–°å»ºæ–‡ä»¶å¤¹æŒ‰é’®');

                const newFolderBtn = document.getElementById('newFolderBtn');
                if (newFolderBtn) {
                    newFolderBtn.click();
                    console.log('âœ… å·²ç‚¹å‡»æ–°å»ºæ–‡ä»¶å¤¹æŒ‰é’®');

                    // æ¸…é™¤URLä¸­çš„è·¯ç”±æ ‡è¯†
                    if (path.includes('/finder/new')) {
                        window.history.replaceState({}, '', '/finder/');
                    } else if (hash === '#new') {
                        window.history.replaceState({}, '', window.location.pathname);
                    }
                } else {
                    console.log('âŒ æ‰¾ä¸åˆ°æ–°å»ºæ–‡ä»¶å¤¹æŒ‰é’®');
                }
            }
        }, 1500);

        // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                imageViewer.closeFolderModal();
            }
        });
    </script>
</body>
</html>
