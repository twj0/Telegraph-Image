<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegraph Finder - 文件管理器</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">

    <!-- Override CSS to fix image rendering issue -->
    <style>
        /* Override the 64px constraint from styles.css */
        .file-icon.image img {
            width: 100% !important;
            height: 120px !important;
            max-width: none !important;
            max-height: none !important;
            min-width: 120px !important;
            min-height: 120px !important;
            object-fit: cover !important;
            border-radius: 8px !important;
            display: block !important;
        }

        /* Ensure parent container has proper size */
        .file-icon.image {
            width: 100% !important;
            height: 120px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            overflow: hidden !important;
            border-radius: 8px !important;
            background: #f0f0f0 !important;
        }

        /* Ensure file item container is properly sized */
        .file-item {
            min-height: 180px !important;
            display: flex !important;
            flex-direction: column !important;
            align-items: center !important;
            justify-content: flex-start !important;
            padding: 12px !important;
            background: #f8f9fa !important;
            border-radius: 12px !important;
            cursor: pointer !important;
            transition: all 0.2s ease !important;
        }

        /* 文件夹样式 */
        .folder-item {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
            border: 2px solid transparent !important;
        }

        .folder-item:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3) !important;
            border-color: rgba(255, 255, 255, 0.3) !important;
        }

        .folder-item .file-icon {
            background: transparent !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            height: 120px !important;
        }

        .folder-item .file-name {
            color: white !important;
            font-weight: 600 !important;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1) !important;
        }

        .folder-item .file-size {
            color: rgba(255, 255, 255, 0.8) !important;
            font-size: 12px !important;
        }

        /* 新建文件夹模态框样式 */
        .modal {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            background: rgba(0, 0, 0, 0.5) !important;
            display: none !important;
            align-items: center !important;
            justify-content: center !important;
            z-index: 1000 !important;
        }

        .modal.show {
            display: flex !important;
        }

        .modal-content {
            background: white !important;
            border-radius: 12px !important;
            padding: 24px !important;
            width: 90% !important;
            max-width: 400px !important;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3) !important;
        }

        .modal-header {
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            margin-bottom: 20px !important;
        }

        .modal-close {
            background: none !important;
            border: none !important;
            font-size: 18px !important;
            cursor: pointer !important;
            color: #999 !important;
        }

        .form-group {
            margin-bottom: 16px !important;
        }

        .form-group label {
            display: block !important;
            margin-bottom: 6px !important;
            font-weight: 600 !important;
            color: #333 !important;
        }

        .form-group input {
            width: 100% !important;
            padding: 10px 12px !important;
            border: 2px solid #e1e5e9 !important;
            border-radius: 8px !important;
            font-size: 14px !important;
        }

        .color-picker {
            display: flex !important;
            align-items: center !important;
            gap: 12px !important;
        }

        .color-presets {
            display: flex !important;
            gap: 8px !important;
        }

        .color-preset {
            width: 24px !important;
            height: 24px !important;
            border-radius: 50% !important;
            cursor: pointer !important;
            border: 2px solid transparent !important;
            transition: all 0.2s ease !important;
        }

        .color-preset:hover,
        .color-preset.selected {
            border-color: #333 !important;
            transform: scale(1.1) !important;
        }

        .form-actions {
            display: flex !important;
            gap: 12px !important;
            justify-content: flex-end !important;
            margin-top: 24px !important;
        }

        .btn-secondary, .btn-primary {
            padding: 10px 20px !important;
            border: none !important;
            border-radius: 8px !important;
            font-weight: 600 !important;
            cursor: pointer !important;
            transition: all 0.2s ease !important;
        }

        .btn-secondary {
            background: #f8f9fa !important;
            color: #6c757d !important;
        }

        .btn-primary {
            background: #007bff !important;
            color: white !important;
        }

        .btn-secondary:hover {
            background: #e9ecef !important;
        }

        .btn-primary:hover {
            background: #0056b3 !important;
        }
    </style>
</head>
<body>
    <!-- 顶部工具栏 -->
    <header class="toolbar">
        <div class="toolbar-left">
            <button id="backBtn" class="btn-icon" title="返回">
                <i class="fas fa-arrow-left"></i>
            </button>
            <button id="forwardBtn" class="btn-icon" title="前进">
                <i class="fas fa-arrow-right"></i>
            </button>
            <div class="breadcrumb" id="breadcrumb">
                <span class="breadcrumb-item">全部文件</span>
            </div>
        </div>
        <div class="toolbar-right">
            <button id="viewModeBtn" class="btn-icon" title="切换视图">
                <i class="fas fa-th"></i>
            </button>
            <button id="newFolderBtn" class="btn-secondary" title="新建文件夹">
                <i class="fas fa-folder-plus"></i>
                新建文件夹
            </button>
            <button id="refreshBtn" class="btn-secondary" title="刷新图片列表">
                <i class="fas fa-sync-alt"></i>
                刷新
            </button>
            <button id="uploadBtn" class="btn-primary">
                <i class="fas fa-upload"></i>
                上传图片
            </button>
        </div>
    </header>

    <!-- 主要内容区域 -->
    <main class="main-content">
        <!-- 侧边栏 -->
        <aside class="sidebar">
            <div class="sidebar-section">
                <h3>图片管理</h3>
                <ul class="nav-list">
                    <li class="nav-item active" data-path="/" data-folder-type="system">
                        <i class="fas fa-images"></i>
                        <span>全部图片</span>
                    </li>
                    <li class="nav-item" data-path="/recent" data-folder-type="system">
                        <i class="fas fa-clock"></i>
                        <span>最近使用</span>
                    </li>
                    <li class="nav-item" data-path="/favorites" data-folder-type="system">
                        <i class="fas fa-star"></i>
                        <span>收藏夹</span>
                    </li>
                </ul>
            </div>

            <div class="sidebar-section">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <h3>我的文件夹</h3>
                    <button id="sidebarNewFolderBtn" class="btn-icon" title="新建文件夹" style="font-size: 12px; padding: 4px;">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                <ul class="nav-list" id="customFoldersList">
                    <!-- 动态加载的自定义文件夹 -->
                </ul>
            </div>

            <div class="sidebar-section">
                <h3>快速操作</h3>
                <ul class="nav-list">
                    <li class="nav-item action-item" data-action="refresh">
                        <i class="fas fa-sync-alt"></i>
                        <span>刷新列表</span>
                    </li>
                    <li class="nav-item action-item" data-action="clear-cache">
                        <i class="fas fa-broom"></i>
                        <span>清理缓存</span>
                    </li>
                </ul>
            </div>
        </aside>

        <!-- 文件显示区域 -->
        <section class="file-area">
            <!-- 加载状态 -->
            <div id="loadingState" class="loading-state">
                <div class="spinner"></div>
                <p>加载中...</p>
            </div>

            <!-- 空状态 -->
            <div id="emptyState" class="empty-state" style="display: none;">
                <div class="empty-icon">
                    <i class="fas fa-images"></i>
                </div>
                <h3>还没有图片</h3>
                <p>拖拽图片到这里或点击上传按钮开始使用</p>
                <button class="btn-primary" onclick="document.getElementById('fileInput').click()">
                    <i class="fas fa-upload"></i>
                    上传图片
                </button>
            </div>

            <!-- 文件网格 -->
            <div id="fileGrid" class="file-grid" style="display: none;">
                <!-- 动态生成的文件项 -->
            </div>

            <!-- 文件列表视图 -->
            <div id="fileList" class="file-list" style="display: none;">
                <table>
                    <thead>
                        <tr>
                            <th>名称</th>
                            <th>大小</th>
                            <th>类型</th>
                            <th>修改时间</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="fileListBody">
                        <!-- 动态生成的文件行 -->
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <!-- 隐藏的文件输入 -->
    <input type="file" id="fileInput" multiple style="display: none;">

    <!-- 上传进度模态框 -->
    <div id="uploadModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>文件上传</h3>
                <button class="modal-close" onclick="closeUploadModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="uploadProgress">
                    <!-- 动态生成的上传进度项 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 图片预览模态框 -->
    <div id="imagePreviewModal" class="modal" style="display: none;">
        <div class="modal-backdrop" onclick="imageFinder.closeImagePreview()"></div>
        <div class="image-preview-content">
            <div class="preview-header">
                <h3 id="previewImageName">图片预览</h3>
                <div class="preview-actions">
                    <button class="btn-icon" onclick="imageFinder.toggleFavorite()" id="favoriteBtn">
                        <i class="fas fa-star"></i>
                    </button>
                    <button class="btn-icon" onclick="imageFinder.downloadCurrentImage()">
                        <i class="fas fa-download"></i>
                    </button>
                    <button class="btn-icon" onclick="imageFinder.copyImageLink()">
                        <i class="fas fa-link"></i>
                    </button>
                    <button class="btn-icon" onclick="imageFinder.closeImagePreview()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="preview-body">
                <img id="previewImage" src="" alt="预览图片">
                <div class="preview-info">
                    <div class="info-item">
                        <span class="label">文件大小:</span>
                        <span id="previewSize">-</span>
                    </div>
                    <div class="info-item">
                        <span class="label">上传时间:</span>
                        <span id="previewDate">-</span>
                    </div>
                    <div class="info-item">
                        <span class="label">图片链接:</span>
                        <input type="text" id="previewUrl" readonly onclick="this.select()">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 右键菜单 -->
    <div id="contextMenu" class="context-menu">
        <!-- 菜单项将通过JavaScript动态生成 -->
    </div>

    <!-- 后台上传进度容器 -->
    <div id="backgroundUploadContainer" class="background-upload-container">
        <!-- 上传任务将通过JavaScript动态添加 -->
    </div>

    <!-- 新建文件夹模态框 -->
    <div id="newFolderModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>新建文件夹</h3>
                <button class="modal-close" id="modalCloseBtn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="folderNameInput">文件夹名称</label>
                    <input type="text" id="folderNameInput" placeholder="请输入文件夹名称" maxlength="50">
                </div>
                <div class="form-group">
                    <label for="folderColorInput">文件夹颜色</label>
                    <div class="color-picker">
                        <input type="color" id="folderColorInput" value="#4A90E2">
                        <div class="color-presets">
                            <span class="color-preset" data-color="#4A90E2" style="background: #4A90E2;"></span>
                            <span class="color-preset" data-color="#34C759" style="background: #34C759;"></span>
                            <span class="color-preset" data-color="#FF9500" style="background: #FF9500;"></span>
                            <span class="color-preset" data-color="#FF3B30" style="background: #FF3B30;"></span>
                            <span class="color-preset" data-color="#AF52DE" style="background: #AF52DE;"></span>
                            <span class="color-preset" data-color="#007AFF" style="background: #007AFF;"></span>
                        </div>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-secondary" id="cancelFolderBtn">取消</button>
                    <button type="button" class="btn-primary" id="createFolderBtn">创建</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 通知容器 -->
    <div id="notifications" class="notifications"></div>

    <script>
        // 极简版Telegraph图片查看器 - 内联版本
        class SimpleImageViewer {
            constructor() {
                this.images = [];
                this.folders = new Map();
                this.currentPath = '/';
                this.currentFolderId = null;
                console.log('🚀 Simple Image Viewer 启动...');
                this.init();
            }

            async init() {
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', () => this.start());
                } else {
                    this.start();
                }
            }

            async start() {
                console.log('📸 开始加载图片...');
                console.log('🌐 用户代理:', navigator.userAgent);
                console.log('🖥️ 屏幕尺寸:', window.innerWidth + 'x' + window.innerHeight);

                this.hideLoading();
                this.bindEvents();

                // 恢复页面状态
                this.restorePageState();

                await this.loadFolders(true); // 优先同步服务器端文件夹
                await this.loadImages(true); // 首次加载强制刷新
                this.renderImages();
                this.renderSidebar(); // 渲染侧边栏
                this.startPeriodicCheck(); // 启动定期检查

                // 添加额外的调试信息
                this.debugPageState();

                // 检查URL路由（放在最后执行）
                setTimeout(() => {
                    this.checkUrlRouting();
                }, 1000);

                console.log('✅ 图片加载完成');
            }

            // 恢复页面状态
            restorePageState() {
                try {
                    const savedState = localStorage.getItem('telegraph_page_state');
                    if (savedState) {
                        const state = JSON.parse(savedState);
                        this.currentPath = state.currentPath || '/';
                        this.currentFolderId = state.currentFolderId || 'all';
                        console.log('📄 恢复页面状态:', state);
                    }
                } catch (error) {
                    console.error('恢复页面状态失败:', error);
                }
            }

            // 保存页面状态
            savePageState() {
                try {
                    const state = {
                        currentPath: this.currentPath,
                        currentFolderId: this.currentFolderId,
                        timestamp: Date.now()
                    };
                    localStorage.setItem('telegraph_page_state', JSON.stringify(state));
                } catch (error) {
                    console.error('保存页面状态失败:', error);
                }
            }

            // 检查URL路由并执行相应操作
            checkUrlRouting() {
                const path = window.location.pathname;
                const hash = window.location.hash;

                console.log('🔗 检查URL路由:', path, hash);

                // 检查是否是新建文件夹路由
                if (path.includes('/finder/new') || hash === '#new') {
                    console.log('📁 检测到新建文件夹路由，自动打开新建文件夹模态框');
                    // 立即执行，不需要延迟
                    this.showNewFolderModal();
                    // 清除URL中的路由标识，避免重复触发
                    if (path.includes('/finder/new')) {
                        window.history.replaceState({}, '', '/finder/');
                    } else if (hash === '#new') {
                        window.history.replaceState({}, '', window.location.pathname);
                    }
                }
            }

            // 优化调试功能 - 减少延迟和日志
            debugPageState() {
                // 只在开发模式下输出详细日志
                const isDev = window.location.hostname === 'localhost';
                if (!isDev) return;

                // 减少延迟
                setTimeout(() => {
                    console.log('🔍 调试页面状态...');

                    const fileArea = document.querySelector('.file-area');
                    const fileGrid = document.getElementById('fileGrid');
                    const images = document.querySelectorAll('.file-icon.image img');

                    // 简化日志输出
                    console.log(`📊 页面状态: fileArea=${!!fileArea}, fileGrid=${!!fileGrid}, 图片=${images.length}`);

                    if (fileArea && fileGrid) {
                        const fileAreaDisplay = window.getComputedStyle(fileArea).display;
                        const fileGridDisplay = window.getComputedStyle(fileGrid).display;
                        console.log(`📊 显示状态: fileArea=${fileAreaDisplay}, fileGrid=${fileGridDisplay}`);
                    }

                    // 只输出第一张图片的信息作为示例
                    if (images.length > 0) {
                        const firstImg = images[0];
                        const rect = firstImg.getBoundingClientRect();
                        console.log(`📊 图片示例: ${firstImg.clientWidth}x${firstImg.clientHeight}, 可见=${rect.width > 0}`);
                    }

                    console.log('🔍 调试完成');
                }, 200); // 减少延迟从1000ms到200ms
            }

            // 优化定期检查机制 - 减少频率和性能影响
            startPeriodicCheck() {
                // 延长检查间隔到60秒，减少性能影响
                setInterval(async () => {
                    // 只在页面可见时检查更新
                    if (!document.hidden) {
                        await this.checkForUpdates();
                    }
                }, 60000);

                // 页面获得焦点时也检查更新（但增加防抖）
                let focusTimeout;
                window.addEventListener('focus', async () => {
                    clearTimeout(focusTimeout);
                    focusTimeout = setTimeout(async () => {
                        console.log('🔍 页面获得焦点，检查更新...');
                        await this.checkForUpdates();
                    }, 1000); // 1秒防抖
                });

                console.log('🔄 已启动优化的定期检查机制');
            }

            hideLoading() {
                const loadingElement = document.querySelector('.loading-state');
                if (loadingElement) loadingElement.style.display = 'none';

                const fileArea = document.querySelector('.file-area');
                if (fileArea) fileArea.style.display = 'block';
            }

            bindEvents() {
                // 上传按钮
                const uploadBtn = document.getElementById('uploadBtn');
                if (uploadBtn) {
                    uploadBtn.addEventListener('click', () => {
                        const fileInput = document.getElementById('fileInput');
                        if (fileInput) fileInput.click();
                    });
                }

                // 新建文件夹按钮
                const newFolderBtn = document.getElementById('newFolderBtn');
                if (newFolderBtn) {
                    newFolderBtn.addEventListener('click', () => {
                        this.showNewFolderModal();
                    });
                }

                // 侧边栏新建文件夹按钮
                const sidebarNewFolderBtn = document.getElementById('sidebarNewFolderBtn');
                if (sidebarNewFolderBtn) {
                    sidebarNewFolderBtn.addEventListener('click', () => {
                        this.showNewFolderModal();
                    });
                }

                // 刷新按钮
                const refreshBtn = document.getElementById('refreshBtn');
                if (refreshBtn) {
                    refreshBtn.addEventListener('click', async () => {
                        console.log('🔄 手动刷新图片列表...');
                        refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 刷新中...';
                        refreshBtn.disabled = true;

                        try {
                            await this.loadFolders();
                            await this.loadImages(true);
                            this.renderImages();
                            this.renderSidebar();
                            this.showSuccessMessage('列表已刷新！');
                        } finally {
                            refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> 刷新';
                            refreshBtn.disabled = false;
                        }
                    });
                }

                // 侧边栏操作项事件
                const actionItems = document.querySelectorAll('.action-item');
                actionItems.forEach(item => {
                    item.addEventListener('click', () => {
                        const action = item.dataset.action;
                        if (action === 'refresh') {
                            document.getElementById('refreshBtn').click();
                        } else if (action === 'clear-cache') {
                            if (confirm('确定要清理缓存吗？这将刷新页面。')) {
                                this.clearCache();
                            }
                        }
                    });
                });

                // 系统文件夹导航
                const systemNavItems = document.querySelectorAll('.nav-item[data-folder-type="system"]');
                systemNavItems.forEach(item => {
                    item.addEventListener('click', () => {
                        document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                        item.classList.add('active');

                        const path = item.dataset.path || '/';
                        let targetId = 'all';

                        if (path.includes('recent')) {
                            targetId = 'recent';
                        } else if (path.includes('favorites')) {
                            targetId = 'favorites';
                        }

                        this.currentFolderId = targetId;
                        this.currentPath = targetId === 'all' ? '/' : `/${targetId}`;
                        this.savePageState();

                        this.loadImages(true).then(() => {
                            this.renderImages();
                            this.renderSidebar();
                            this.updateActiveNavigation();
                        });

                        this.updateBreadcrumb();
                        this.updateActiveNavigation();
                    });
                });

                // 文件输入
                const fileInput = document.getElementById('fileInput');
                if (fileInput) {
                    fileInput.addEventListener('change', (e) => {
                        this.handleFileUpload(e.target.files);
                    });
                }

                // 拖拽上传
                const fileArea = document.querySelector('.file-area');
                if (fileArea) {
                    fileArea.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        fileArea.classList.add('drag-over');
                    });

                    fileArea.addEventListener('dragleave', (e) => {
                        e.preventDefault();
                        fileArea.classList.remove('drag-over');
                    });

                    fileArea.addEventListener('drop', (e) => {
                        e.preventDefault();
                        fileArea.classList.remove('drag-over');
                        this.handleFileUpload(e.dataTransfer.files);
                    });
                }
            }

            // 清理缓存功能
            clearCache() {
                try {
                    // 清理localStorage
                    localStorage.removeItem('telegraph_image_list');
                    localStorage.removeItem('finder_folders');
                    localStorage.removeItem('finder_folder_structure');
                    localStorage.removeItem('telegraph_folders_cache');
                    localStorage.removeItem('telegraph_page_state');
                    
                    // 清理所有以folder_开头的项
                    const keysToRemove = [];
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && key.startsWith('folder_')) {
                            keysToRemove.push(key);
                        }
                    }
                    keysToRemove.forEach(key => localStorage.removeItem(key));
                    
                    // 清理sessionStorage
                    sessionStorage.clear();
                    
                    this.showNotification('缓存已清理，页面将自动刷新', 'success');
                    
                    // 延迟刷新页面
                    setTimeout(() => {
                        window.location.reload(true);
                    }, 1500);
                    
                    console.log('✅ 缓存清理完成');
                } catch (error) {
                    console.error('❌ 清理缓存失败:', error);
                    this.showNotification('清理缓存失败: ' + error.message, 'error');
                }
            }

            async loadImages(forceRefresh = false) {
                console.log('📸 加载图片列表...', forceRefresh ? '(强制刷新)' : '');

                try {
                    // 添加时间戳避免缓存
                    const timestamp = forceRefresh ? `?t=${Date.now()}` : '';
                    const response = await fetch(`/api/manage/list${timestamp}`, {
                        method: 'GET',
                        headers: {
                            'Cache-Control': 'no-cache',
                            'Pragma': 'no-cache'
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        this.images = this.filterImages(data);
                        this.updateFolderCounts();
                        console.log(`✅ 加载了 ${this.images.length} 张图片`);

                        // 保存到本地存储，用于跨浏览器同步检测
                        this.saveImageListToStorage();
                    } else {
                        throw new Error(`HTTP ${response.status}`);
                    }
                } catch (error) {
                    console.log('🎭 API不可用，使用演示数据');
                    this.images = this.getDemoImages();
                    this.updateFolderCounts();
                }
            }

            // 保存图片列表到本地存储
            saveImageListToStorage() {
                try {
                    const imageList = this.images.map(img => ({
                        id: img.id,
                        name: img.name,
                        size: img.size,
                        uploadDate: img.uploadDate
                    }));
                    localStorage.setItem('telegraph_image_list', JSON.stringify({
                        timestamp: Date.now(),
                        images: imageList
                    }));
                } catch (error) {
                    console.error('保存图片列表失败:', error);
                }
            }

            // 检查是否需要刷新（跨浏览器同步）
            async checkForUpdates() {
                try {
                    const stored = localStorage.getItem('telegraph_image_list');
                    if (!stored) return;

                    const { timestamp, images: storedImages } = JSON.parse(stored);
                    const currentImages = this.images.map(img => img.id).sort();
                    const storedImageIds = storedImages.map(img => img.id).sort();

                    // 如果图片列表不一致，强制刷新
                    if (JSON.stringify(currentImages) !== JSON.stringify(storedImageIds)) {
                        console.log('🔄 检测到图片列表变化，自动刷新...');
                        await this.loadImages(true);
                        this.renderImages();
                        this.renderSidebar();
                    }
                } catch (error) {
                    console.error('检查更新失败:', error);
                }
            }

            filterImages(files) {
                if (!Array.isArray(files)) return [];

                let filteredFiles = files.filter(file => this.isImageFile(file.name));

                // 根据当前文件夹过滤
                if (this.currentFolderId && this.currentFolderId !== 'all') {
                    if (this.currentFolderId === 'recent') {
                        // 最近使用：显示最近7天的图片
                        const sevenDaysAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
                        filteredFiles = filteredFiles.filter(file =>
                            (file.metadata?.TimeStamp || 0) > sevenDaysAgo
                        );
                    } else if (this.currentFolderId === 'favorites') {
                        // 收藏夹：显示收藏的图片
                        filteredFiles = filteredFiles.filter(file =>
                            file.metadata?.liked === true
                        );
                    } else {
                        // 自定义文件夹：根据folderId或parentFolder过滤
                        filteredFiles = filteredFiles.filter(file =>
                            file.metadata?.folderId === this.currentFolderId ||
                            file.metadata?.parentFolder === this.currentFolderId
                        );
                    }
                }

                return filteredFiles
                    .map(file => {
                        const rawFolderId = file.metadata?.folderId ?? file.metadata?.parentFolder ?? null;
                        const folderId = this.normalizeFolderId(rawFolderId);

                        return {
                            id: file.name,
                            name: file.metadata?.fileName || file.name,
                            size: file.metadata?.fileSize || 0,
                            url: `/file/${file.name}`,
                            uploadDate: new Date(file.metadata?.TimeStamp || Date.now()),
                            folderId,
                            rawFolderId,
                            liked: file.metadata?.liked || false
                        };
                    })
                    .sort((a, b) => b.uploadDate - a.uploadDate);
            }

            isImageFile(filename) {
                const imageExtensions = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg', 'bmp', 'ico'];
                const ext = filename.split('.').pop().toLowerCase();
                return imageExtensions.includes(ext);
            }

            // 规范化文件夹ID，统一处理根目录标识
            normalizeFolderId(folderId) {
                if (folderId === undefined || folderId === null) {
                    return null;
                }

                const normalized = String(folderId).trim();
                if (normalized === '' || normalized === '/' || normalized === 'root' || normalized === 'all') {
                    return null;
                }

                return normalized;
            }

            // 判断当前是否处于根目录视图
            isRootView() {
                return (
                    !this.currentFolderId ||
                    this.currentFolderId === 'all' ||
                    this.currentFolderId === '/' ||
                    this.currentPath === '/'
                );
            }

            getDemoImages() {
                return [
                    {
                        id: 'demo_1',
                        name: '演示图片1.jpg',
                        size: 1024000,
                        url: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iIzQyODVmNCIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmaWxsPSJ3aGl0ZSIgZm9udC1zaXplPSIxNiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPuekuuS+i+WbvueJhzE8L3RleHQ+PC9zdmc+',
                        uploadDate: new Date(Date.now() - 86400000)
                    },
                    {
                        id: 'demo_2',
                        name: '演示图片2.png',
                        size: 2048000,
                        url: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iIzM0Yzc1OSIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmaWxsPSJ3aGl0ZSIgZm9udC1zaXplPSIxNiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPuekuuS+i+WbvueJhzI8L3RleHQ+PC9zdmc+',
                        uploadDate: new Date(Date.now() - 172800000)
                    },
                    {
                        id: 'demo_3',
                        name: '演示图片3.jpg',
                        size: 1536000,
                        url: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2ZmOTUwMCIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmaWxsPSJ3aGl0ZSIgZm9udC1zaXplPSIxNiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPuekuuS+i+WbvueJhzM8L3RleHQ+PC9zdmc+',
                        uploadDate: new Date(Date.now() - 259200000)
                    }
                ];
            }

            renderImages() {
                const fileGrid = document.getElementById('fileGrid');
                const emptyState = document.getElementById('emptyState');

                if (!fileGrid) {
                    console.error('❌ 找不到fileGrid元素');
                    return;
                }

                // 获取当前文件夹的子文件夹
                const subFolders = this.getCurrentSubFolders();

                // 获取当前文件夹的图片（根据文件夹过滤）
                const currentImages = this.getCurrentFolderImages();
                const totalItems = subFolders.length + currentImages.length;

                if (totalItems === 0) {
                    if (emptyState) emptyState.style.display = 'flex';
                    fileGrid.style.display = 'none';
                    return;
                }

                if (emptyState) emptyState.style.display = 'none';
                fileGrid.style.display = 'grid';

                // 渲染文件夹（排在前面）
                const foldersHtml = subFolders.map(folder => `
                    <div class="file-item folder-item" data-folder-id="${folder.id}">
                        <div class="file-icon folder">
                            <i class="fas fa-folder" style="color: ${folder.color || '#4A90E2'}; font-size: 48px;"></i>
                        </div>
                        <div class="file-name" title="${folder.name}">${folder.name}</div>
                        <div class="file-size">${folder.fileCount || 0} 个文件</div>
                    </div>
                `).join('');

                // 渲染图片文件（只显示当前文件夹的图片）
                const imagesHtml = currentImages.map(image => `
                    <div class="file-item image-item" data-image-id="${image.id}">
                        <div class="file-icon image">
                            <img src="${image.url}" alt="${image.name}" loading="lazy"
                                 style="
                                    width: 100% !important;
                                    height: 120px !important;
                                    max-width: none !important;
                                    max-height: none !important;
                                    min-width: 120px !important;
                                    min-height: 120px !important;
                                    object-fit: cover !important;
                                    border-radius: 8px !important;
                                    display: block !important;
                                 "
                                 onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjEyMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTIwIiBoZWlnaHQ9IjEyMCIgZmlsbD0iI2Y1ZjVmNSIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmaWxsPSIjOTk5IiBmb250LXNpemU9IjE0IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+5Zu+54mH5Yqg6L295aSx6LSlPC90ZXh0Pjwvc3ZnPg=='">
                        </div>
                        <div class="file-name" title="${image.name}">${image.name}</div>
                        <div class="file-size">${this.formatFileSize(image.size)}</div>
                    </div>
                `).join('');

                fileGrid.innerHTML = foldersHtml + imagesHtml;

                this.bindFileEvents();

                // Force override CSS constraints after DOM update
                setTimeout(() => {
                    this.forceImageStyles();
                    this.forcePageRerender();
                }, 100);

                console.log(`✅ 渲染了 ${subFolders.length} 个文件夹和 ${currentImages.length} 张图片`);
            }

            // 获取当前文件夹的图片
            getCurrentFolderImages() {
                if (this.isRootView()) {
                    // 根目录展示所有未绑定文件夹的图片
                    return this.images.filter(image => !image.folderId || image.folderId === 'all');
                }

                // 在特定文件夹内只显示属于该文件夹的图片
                return this.images.filter(image => image.folderId === this.currentFolderId);
            }

            // 获取当前文件夹的子文件夹
            getCurrentSubFolders() {
                if (this.isRootView()) {
                    // 在根目录显示所有顶级文件夹
                    return Array.from(this.folders.values()).filter(folder =>
                        !folder.isSystem && (folder.parentFolder === 'root' || !folder.parentFolder)
                    );
                } else if (this.currentFolderId && this.currentFolderId !== 'recent' && this.currentFolderId !== 'favorites') {
                    // 在特定文件夹中显示子文件夹
                    return Array.from(this.folders.values()).filter(folder =>
                        folder.parentFolder === this.currentFolderId
                    );
                }
                return [];
            }

            bindFileEvents() {
                // 绑定文件夹点击事件
                const folderItems = document.querySelectorAll('.folder-item');
                folderItems.forEach(item => {
                    item.addEventListener('dblclick', () => {
                        const folderId = item.dataset.folderId;
                        this.navigateToFolder(folderId);
                    });

                    item.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        const folderId = item.dataset.folderId;
                        this.showFolderContextMenu(e, folderId);
                    });
                });

                // 绑定图片点击事件
                const imageItems = document.querySelectorAll('.image-item');
                imageItems.forEach(item => {
                    item.addEventListener('click', () => {
                        const imageId = item.dataset.imageId;
                        const image = this.images.find(img => img.id === imageId);
                        if (image) {
                            window.open(image.url, '_blank');
                        }
                    });

                    item.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        this.showContextMenu(e, item.dataset.imageId);
                    });
                });
            }

            // 优化图片样式应用 - 减少DOM操作
            forceImageStyles() {
                console.log('🎨 优化应用图片样式...');

                // 批量处理，减少重绘
                const images = document.querySelectorAll('.file-icon.image img');
                const containers = document.querySelectorAll('.file-icon.image');

                // 使用requestAnimationFrame优化性能
                requestAnimationFrame(() => {
                    images.forEach((img, index) => {
                        // 使用cssText一次性设置所有样式
                        img.style.cssText += 'width: 100% !important; height: 120px !important; max-width: none !important; max-height: none !important; min-width: 120px !important; min-height: 120px !important; object-fit: cover !important; border-radius: 8px !important; display: block !important;';
                        console.log(`✅ 应用样式到图片 ${index + 1}: 120x120`);
                    });

                    containers.forEach((container, index) => {
                        // 使用cssText一次性设置所有样式
                        container.style.cssText += 'width: 100% !important; height: 120px !important; display: flex !important; align-items: center !important; justify-content: center !important; overflow: hidden !important; border-radius: 8px !important; background: #f0f0f0 !important;';
                        console.log(`✅ 应用容器样式 ${index + 1}`);
                    });

                    console.log('🎨 图片样式优化应用完成');
                });
            }

            // 强制页面重新渲染 - 解决浏览器渲染问题
            forcePageRerender() {
                console.log('🔄 强制页面重新渲染...');

                const fileArea = document.querySelector('.file-area');
                const fileGrid = document.getElementById('fileGrid');

                if (fileArea && fileGrid) {
                    // 方法1: 强制重排
                    fileArea.style.display = 'none';
                    fileArea.offsetHeight; // 触发重排
                    fileArea.style.display = 'block';

                    // 方法2: 强制重绘
                    fileGrid.style.transform = 'translateZ(0)';
                    fileGrid.style.willChange = 'transform';

                    // 方法3: 添加可见性强制
                    fileGrid.style.setProperty('visibility', 'visible', 'important');
                    fileGrid.style.setProperty('opacity', '1', 'important');
                    fileGrid.style.setProperty('display', 'grid', 'important');

                    // 优化布局计算 - 减少延迟
                    requestAnimationFrame(() => {
                        fileGrid.style.cssText += 'grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)) !important; gap: 20px !important; padding: 20px !important;';

                        // 批量处理文件项
                        const fileItems = document.querySelectorAll('.file-item');
                        fileItems.forEach((item, index) => {
                            if (item.style.display === 'none' || !item.style.visibility) {
                                item.style.cssText += 'display: flex !important; visibility: visible !important; opacity: 1 !important;';
                                console.log(`✅ 强制显示文件项 ${index + 1}`);
                            }
                        });

                        console.log('🔄 页面渲染优化完成');
                    });
                }
            }

            removeExistingContextMenu() {
                const existingMenu = document.querySelector('.context-menu');
                if (existingMenu) {
                    existingMenu.remove();
                }
            }

            showContextMenu(e, imageId) {
                const image = this.images.find(img => img.id === imageId);
                if (!image) return;

                this.removeExistingContextMenu();

                // 创建新的菜单
                const contextMenu = document.createElement('div');
                contextMenu.className = 'context-menu';
                contextMenu.id = 'contextMenu'; // 确保ID存在以便CSS选择器工作
                
                contextMenu.innerHTML = `
                    <div class="context-menu-item" data-action="copy">
                        <i class="fas fa-link"></i> 复制链接
                    </div>
                    <div class="context-menu-item" data-action="download">
                        <i class="fas fa-download"></i> 下载图片
                    </div>
                    <div class="context-menu-separator"></div>
                    <div class="context-menu-item danger" data-action="delete">
                        <i class="fas fa-trash"></i> 删除图片
                    </div>
                `;

                document.body.appendChild(contextMenu);
                
                // 定位菜单
                contextMenu.style.left = `${e.pageX}px`;
                contextMenu.style.top = `${e.pageY}px`;
                contextMenu.classList.add('show');

                // 确保菜单在屏幕内
                const rect = contextMenu.getBoundingClientRect();
                if (rect.right > window.innerWidth) {
                    contextMenu.style.left = `${e.pageX - rect.width}px`;
                }
                if (rect.bottom > window.innerHeight) {
                    contextMenu.style.top = `${e.pageY - rect.height}px`;
                }

                // 绑定事件
                contextMenu.querySelectorAll('.context-menu-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const action = item.dataset.action;
                        this.handleContextMenuAction(action, image, imageId);
                        contextMenu.remove();
                    });
                });

                // 点击其他地方关闭
                setTimeout(() => {
                    document.addEventListener('click', () => contextMenu.remove(), { once: true });
                }, 0);
            }

            handleContextMenuAction(action, image, imageId) {
                switch(action) {
                    case 'copy':
                        this.copyToClipboard(window.location.origin + image.url);
                        break;
                    case 'download':
                        this.downloadImage(image);
                        break;
                    case 'delete':
                        this.deleteImage(imageId);
                        break;
                }
            }

            showFolderContextMenu(e, folderId) {
                const folder = this.folders.get(folderId);
                if (!folder || folder.isSystem) return;

                this.removeExistingContextMenu();

                const contextMenu = document.createElement('div');
                contextMenu.className = 'context-menu';
                contextMenu.id = 'folderContextMenu';

                contextMenu.innerHTML = `
                    <div class="context-menu-item" data-action="open">
                        <i class="fas fa-folder-open"></i> 打开文件夹
                    </div>
                    <div class="context-menu-item danger" data-action="delete">
                        <i class="fas fa-trash"></i> 删除文件夹
                    </div>
                `;

                document.body.appendChild(contextMenu);

                contextMenu.style.left = `${e.pageX}px`;
                contextMenu.style.top = `${e.pageY}px`;
                contextMenu.classList.add('show');

                const rect = contextMenu.getBoundingClientRect();
                if (rect.right > window.innerWidth) {
                    contextMenu.style.left = `${e.pageX - rect.width}px`;
                }
                if (rect.bottom > window.innerHeight) {
                    contextMenu.style.top = `${e.pageY - rect.height}px`;
                }

                contextMenu.querySelectorAll('.context-menu-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const action = item.dataset.action;
                        this.handleFolderContextMenuAction(action, folder);
                        contextMenu.remove();
                    });
                });

                setTimeout(() => {
                    document.addEventListener('click', () => this.removeExistingContextMenu(), { once: true });
                }, 0);
            }

            handleFolderContextMenuAction(action, folder) {
                switch (action) {
                    case 'open':
                        this.navigateToFolder(folder.id);
                        break;
                    case 'delete':
                        this.deleteFolder(folder);
                        break;
                }
            }

            async deleteFolder(folder) {
                if (!folder || folder.isSystem) return;

                const confirmMessage = `确定要删除文件夹 "${folder.name}" 吗？\n其中的图片将移动到根目录。`;
                if (!confirm(confirmMessage)) {
                    return;
                }

                try {
                    this.showNotification(`正在删除文件夹 "${folder.name}"...`, 'info');

                    const response = await fetch(`/api/manage/folders-enhanced?id=${encodeURIComponent(folder.id)}`, {
                        method: 'DELETE'
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.error || '删除失败');
                    }

                    // 从本地状态中移除文件夹，并清除缓存
                    this.folders.delete(folder.id);
                    localStorage.removeItem('telegraph_folders_cache');

                    // 如果当前正在浏览被删除的文件夹，则退回根目录
                    if (this.currentFolderId === folder.id) {
                        this.currentFolderId = 'all';
                        this.currentPath = '/';
                    }

                    this.savePageState();

                    // 重新拉取文件夹和图片数据
                    await this.loadFolders(true);
                    await this.loadImages(true);

                    this.renderSidebar();
                    this.renderImages();
                    this.updateBreadcrumb();
                    this.updateActiveNavigation();

                    this.showNotification(`文件夹 "${folder.name}" 已删除`, 'success');
                } catch (error) {
                    console.error('删除文件夹失败:', error);
                    this.showNotification(`删除文件夹失败：${error.message}`, 'error');
                }
            }

            copyToClipboard(text) {
                navigator.clipboard.writeText(text).then(() => {
                    alert('链接已复制到剪贴板！');
                }).catch(() => {
                    prompt('请手动复制链接:', text);
                });
            }

            downloadImage(image) {
                const a = document.createElement('a');
                a.href = image.url;
                a.download = image.name;
                a.click();
            }

            async deleteImage(imageId) {
                const image = this.images.find(img => img.id === imageId);
                if (!image) return;

                if (!confirm(`确定要删除图片 "${image.name}" 吗？\n\n此操作不可撤销！`)) return;

                console.log('🗑️ 开始删除图片:', imageId);

                try {
                    const response = await fetch(`/api/manage/delete/${imageId}`, {
                        method: 'DELETE',
                        headers: {
                            'Cache-Control': 'no-cache',
                            'Pragma': 'no-cache'
                        }
                    });

                    if (response.ok) {
                        console.log('✅ 服务器删除成功');

                        // 显示成功消息
                        this.showSuccessMessage(`图片 "${image.name}" 删除成功！`);

                        // 等待1秒确保服务器处理完成
                        await new Promise(resolve => setTimeout(resolve, 1000));

                        // 强制从服务器重新加载图片列表
                        await this.loadImages(true);
                        this.renderImages();
                        this.renderSidebar();

                        console.log('🔄 图片列表已刷新');
                    } else {
                        const errorText = await response.text();
                        console.error('❌ 删除失败:', response.status, errorText);
                        alert(`删除失败: ${response.status} ${errorText}`);
                    }
                } catch (error) {
                    console.error('❌ 删除异常:', error);
                    alert('删除失败：' + error.message);
                }
            }

            handleFileUpload(files) {
                if (!files || files.length === 0) return;

                const validFiles = Array.from(files).filter(file => {
                    if (this.isImageFile(file.name)) {
                        // 可以在这里添加文件大小校验
                        return true;
                    }
                    this.showNotification(`${file.name} (不支持的格式)`, 'warning');
                    return false;
                });

                if (validFiles.length === 0) {
                    this.showNotification('没有有效的图片文件可上传', 'error');
                    return;
                }

                // 使用后台上传
                for (let file of validFiles) {
                    this.createBackgroundUploadTask(file);
                }
            }

            createBackgroundUploadTask(file) {
                const container = document.getElementById('backgroundUploadContainer');
                const taskId = 'upload_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                
                const taskElement = document.createElement('div');
                taskElement.className = 'upload-task';
                taskElement.id = taskId;
                taskElement.innerHTML = `
                    <div class="upload-task-header">
                        <div class="upload-task-info">
                            <div class="upload-task-name" title="${file.name}">${file.name}</div>
                            <div class="upload-task-status">准备上传...</div>
                        </div>
                        <button class="upload-task-close" onclick="imageViewer.cancelUploadTask('${taskId}')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="upload-progress-bar">
                        <div class="upload-progress-fill" style="width: 0%"></div>
                    </div>
                `;
                
                container.appendChild(taskElement);
                
                // 开始上传
                this.performBackgroundUpload(file, taskId);
            }

            async performBackgroundUpload(file, taskId) {
                const taskElement = document.getElementById(taskId);
                if (!taskElement) return;

                const statusElement = taskElement.querySelector('.upload-task-status');
                const progressFill = taskElement.querySelector('.upload-progress-fill');
                
                try {
                    statusElement.textContent = '上传中...';
                    
                    // 优化进度条动画 - 减少延迟
                    for (let i = 0; i <= 90; i += 15) {
                        await new Promise(resolve => setTimeout(resolve, 50));
                        if (!document.getElementById(taskId)) return; // 任务可能已被取消
                        progressFill.style.width = i + '%';
                        statusElement.textContent = `上传中... ${i}%`;
                    }

                    const formData = new FormData();
                    formData.append('file', file);

                    // 添加当前文件夹ID
                    if (this.currentFolderId && this.currentFolderId !== 'all') {
                        formData.append('folderId', this.currentFolderId);
                        formData.append('parentFolder', this.currentFolderId);
                    }

                    const response = await fetch('/upload', {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        progressFill.style.width = '100%';
                        statusElement.textContent = '上传完成';
                        taskElement.classList.add('success');
                        
                        this.showNotification(`${file.name} 上传成功！`, 'success');
                        
                        setTimeout(async () => {
                            await this.loadImages(true);
                            this.renderImages();
                            this.renderSidebar();
                        }, 1000);
                        
                    } else {
                        throw new Error(`HTTP ${response.status}`);
                    }

                } catch (error) {
                    if (!document.getElementById(taskId)) return;
                    progressFill.style.width = '100%';
                    statusElement.textContent = '上传失败';
                    taskElement.classList.add('error');
                    this.showNotification(`${file.name} 上传失败: ${error.message}`, 'error');
                }
                
                // 3秒后自动移除任务
                setTimeout(() => {
                    if (taskElement) {
                        taskElement.classList.add('completed');
                        setTimeout(() => taskElement.remove(), 300);
                    }
                }, 3000);
            }

            cancelUploadTask(taskId) {
                const taskElement = document.getElementById(taskId);
                if (taskElement) {
                    taskElement.remove();
                    this.showNotification('上传已取消', 'info');
                }
            }

            // 显示通知
            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: ${type === 'success' ? '#34c759' : type === 'error' ? '#ff3b30' : type === 'warning' ? '#ff9500' : '#007aff'};
                    color: white;
                    padding: 12px 16px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    z-index: 1000;
                    max-width: 300px;
                    word-wrap: break-word;
                `;
                notification.textContent = message;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 4000);
            }

            showSuccessMessage(message) {
                this.showNotification(message, 'success');
            }

            formatFileSize(bytes) {
                if (bytes === 0) return '0 B';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            // 加载文件夹列表
            async loadFolders(forceRefresh = false) {
                console.log('📁 加载文件夹列表...', forceRefresh ? '(强制刷新)' : '(实时同步)');

                const fallbackToCache = () => {
                    const cachedFolders = this.loadFoldersFromCache();
                    if (cachedFolders && cachedFolders.length > 0) {
                        this.hydrateFolders(cachedFolders);
                        console.log(`✅ 从缓存恢复 ${cachedFolders.length} 个文件夹`);
                        return true;
                    }
                    return false;
                };

                const cacheBuster = `?t=${Date.now()}`;

                try {
                    const response = await fetch(`/api/manage/folders-enhanced${cacheBuster}`);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }

                    const folders = await response.json();
                    const normalizedFolders = Array.isArray(folders) ? folders : [];

                    this.hydrateFolders(normalizedFolders);
                    this.saveFoldersToCache(normalizedFolders);
                    console.log(`✅ 同步 ${normalizedFolders.length} 个文件夹`);
                } catch (error) {
                    console.error('📁 获取服务器文件夹失败:', error);

                    if (!fallbackToCache()) {
                        console.log('📁 使用默认文件夹');
                        this.initDefaultFolders();
                    }
                }
            }

            // 从缓存加载文件夹
            loadFoldersFromCache() {
                try {
                    const cached = localStorage.getItem('telegraph_folders_cache');
                    if (cached) {
                        const data = JSON.parse(cached);
                        // 检查缓存是否过期（5分钟）
                        if (Date.now() - data.timestamp < 5 * 60 * 1000) {
                            return data.folders;
                        }
                    }
                } catch (error) {
                    console.error('加载文件夹缓存失败:', error);
                }
                return null;
            }

            // 保存文件夹到缓存
            saveFoldersToCache(folders) {
                try {
                    localStorage.setItem('telegraph_folders_cache', JSON.stringify({
                        timestamp: Date.now(),
                        folders: folders
                    }));
                } catch (error) {
                    console.error('保存文件夹缓存失败:', error);
                }
            }

            // 构建系统文件夹基础数据
            prepareSystemFolders() {
                this.folders.clear();

                const systemFolders = [
                    { id: 'all', name: '全部图片', icon: 'fas fa-images', isSystem: true },
                    { id: 'recent', name: '最近使用', icon: 'fas fa-clock', isSystem: true },
                    { id: 'favorites', name: '收藏夹', icon: 'fas fa-star', isSystem: true }
                ];

                systemFolders.forEach(folder => {
                    this.folders.set(folder.id, {
                        fileCount: 0,
                        ...folder
                    });
                });
            }

            hydrateFolders(folders = []) {
                this.prepareSystemFolders();

                folders.forEach(folder => {
                    if (!folder || !folder.id) return;

                    if (folder.isSystem && this.folders.has(folder.id)) {
                        this.folders.set(folder.id, {
                            ...this.folders.get(folder.id),
                            ...folder,
                            fileCount: folder.fileCount ?? this.folders.get(folder.id).fileCount ?? 0
                        });
                    } else {
                        this.folders.set(folder.id, {
                            fileCount: folder.fileCount ?? 0,
                            ...folder,
                            isSystem: Boolean(folder.isSystem)
                        });
                    }
                });

                this.updateFolderCounts();
                this.updateActiveNavigation();
            }

            // 初始化默认文件夹
            initDefaultFolders() {
                this.prepareSystemFolders();
                this.updateFolderCounts();
                this.updateActiveNavigation();
            }

            // 渲染侧边栏
            renderSidebar() {
                const customFoldersList = document.getElementById('customFoldersList');
                if (!customFoldersList) return;

                const customFolders = Array.from(this.folders.values()).filter(folder => !folder.isSystem);

                if (customFolders.length === 0) {
                    customFoldersList.innerHTML = '<li style="padding: 8px 16px; color: #999; font-size: 12px;">暂无自定义文件夹</li>';
                } else {
                    customFoldersList.innerHTML = customFolders.map(folder => `
                        <li class="nav-item" data-path="${folder.id}" data-folder-type="custom">
                            <i class="fas fa-folder" style="color: ${folder.color || '#4A90E2'};"></i>
                            <span>${folder.name}</span>
                            <span class="folder-count">${folder.fileCount || 0}</span>
                        </li>
                    `).join('');

                    // 绑定点击事件
                    customFoldersList.querySelectorAll('.nav-item').forEach(item => {
                        item.addEventListener('click', () => {
                            this.navigateToFolder(item.dataset.path);
                        });

                        item.addEventListener('contextmenu', (e) => {
                            e.preventDefault();
                            this.showFolderContextMenu(e, item.dataset.path);
                        });
                    });
                }

                this.updateActiveNavigation();
            }

            // 显示新建文件夹模态框
            showNewFolderModal() {
                const modal = document.getElementById('newFolderModal');
                const nameInput = document.getElementById('folderNameInput');
                const colorInput = document.getElementById('folderColorInput');
                const cancelBtn = document.getElementById('cancelFolderBtn');
                const createBtn = document.getElementById('createFolderBtn');
                const closeBtn = document.getElementById('modalCloseBtn');

                // 重置表单
                nameInput.value = '';
                colorInput.value = '#4A90E2';
                nameInput.style.borderColor = '#e1e5e9';

                modal.classList.add('show');
                nameInput.focus();

                // 移除之前的事件监听器
                const newCancelBtn = cancelBtn.cloneNode(true);
                const newCreateBtn = createBtn.cloneNode(true);
                const newCloseBtn = closeBtn.cloneNode(true);
                cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
                createBtn.parentNode.replaceChild(newCreateBtn, createBtn);
                closeBtn.parentNode.replaceChild(newCloseBtn, closeBtn);

                // 绑定关闭按钮
                newCloseBtn.addEventListener('click', () => {
                    this.closeFolderModal();
                });

                // 绑定取消按钮
                newCancelBtn.addEventListener('click', () => {
                    this.closeFolderModal();
                });

                // 绑定创建按钮
                newCreateBtn.addEventListener('click', () => {
                    this.createNewFolder();
                });

                // 绑定颜色预设点击事件
                document.querySelectorAll('.color-preset').forEach(preset => {
                    preset.addEventListener('click', () => {
                        const color = preset.dataset.color;
                        colorInput.value = color;
                        document.querySelectorAll('.color-preset').forEach(p => p.classList.remove('selected'));
                        preset.classList.add('selected');
                    });
                });

                // 绑定回车键创建
                const handleKeyPress = (e) => {
                    if (e.key === 'Enter') {
                        this.createNewFolder();
                    } else if (e.key === 'Escape') {
                        this.closeFolderModal();
                    }
                };
                nameInput.removeEventListener('keypress', handleKeyPress);
                nameInput.addEventListener('keypress', handleKeyPress);
            }

            // 关闭文件夹模态框
            closeFolderModal() {
                const modal = document.getElementById('newFolderModal');
                modal.classList.remove('show');
            }

            // 导航到文件夹
            navigateToFolder(folderId) {
                console.log('📁 导航到文件夹:', folderId);
                this.currentFolderId = folderId;
                this.currentPath = folderId === 'all' ? '/' : folderId;

                // 保存页面状态
                this.savePageState();

                this.updateActiveNavigation();

                // 重新加载和渲染图片
                this.loadImages(true).then(() => {
                    this.renderImages();
                    this.renderSidebar();
                    this.updateActiveNavigation();
                });

                // 更新面包屑
                this.updateBreadcrumb();
            }

            // 更新面包屑导航
            updateBreadcrumb() {
                const breadcrumb = document.getElementById('breadcrumb');
                if (!breadcrumb) return;

                let breadcrumbHtml = '';
                if (this.currentFolderId === 'all' || this.currentPath === '/') {
                    breadcrumbHtml = '<span class="breadcrumb-item">全部图片</span>';
                } else {
                    const folder = this.folders.get(this.currentFolderId);
                    if (folder) {
                        breadcrumbHtml = `
                            <span class="breadcrumb-item" onclick="imageViewer.navigateToFolder('all')">全部图片</span>
                            <span class="breadcrumb-separator">/</span>
                            <span class="breadcrumb-item">${folder.name}</span>
                        `;
                    }
                }
                breadcrumb.innerHTML = breadcrumbHtml;
            }

            updateActiveNavigation() {
                const systemPathMap = {
                    all: '/',
                    recent: '/recent',
                    favorites: '/favorites'
                };

                const expectedSystemPath = systemPathMap[this.currentFolderId] || '/';

                document.querySelectorAll('.nav-item[data-folder-type="system"]').forEach(item => {
                    item.classList.toggle('active', item.dataset.path === expectedSystemPath);
                });

                document.querySelectorAll('.nav-item[data-folder-type="custom"]').forEach(item => {
                    item.classList.toggle('active', item.dataset.path === this.currentFolderId);
                });
            }

            updateFolderCounts() {
                if (!(this.folders instanceof Map)) {
                    this.folders = new Map();
                }

                if (this.folders.size === 0) {
                    this.prepareSystemFolders();
                }

                const images = Array.isArray(this.images) ? this.images : [];
                const folderCounts = new Map();
                const weekAgo = Date.now() - 7 * 24 * 60 * 60 * 1000;

                let recentCount = 0;
                let favoritesCount = 0;

                images.forEach(image => {
                    const uploadTime = image.uploadDate instanceof Date
                        ? image.uploadDate.getTime()
                        : Number(image.uploadDate) || 0;

                    if (uploadTime && uploadTime > weekAgo) {
                        recentCount++;
                    }

                    if (image.liked) {
                        favoritesCount++;
                    }

                    const folderKey = image.folderId || 'root';
                    folderCounts.set(folderKey, (folderCounts.get(folderKey) || 0) + 1);
                });

                const allFolder = this.folders.get('all');
                if (allFolder) {
                    allFolder.fileCount = images.length;
                }

                const recentFolder = this.folders.get('recent');
                if (recentFolder) {
                    recentFolder.fileCount = recentCount;
                }

                const favoritesFolder = this.folders.get('favorites');
                if (favoritesFolder) {
                    favoritesFolder.fileCount = favoritesCount;
                }

                this.folders.forEach(folder => {
                    if (folder.isSystem) return;
                    folder.fileCount = folderCounts.get(folder.id) || 0;
                });
            }

            // 创建新文件夹
            async createNewFolder() {
                const nameInput = document.getElementById('folderNameInput');
                const colorInput = document.getElementById('folderColorInput');
                const createBtn = document.querySelector('.btn-primary');

                const name = nameInput.value.trim();
                if (!name) {
                    nameInput.style.borderColor = '#dc3545';
                    nameInput.focus();
                    this.showNotification('请输入文件夹名称', 'error');
                    return;
                }

                // 检查名称长度
                if (name.length > 50) {
                    nameInput.style.borderColor = '#dc3545';
                    this.showNotification('文件夹名称不能超过50个字符', 'error');
                    return;
                }

                // 检查是否已存在同名文件夹
                const existingFolder = Array.from(this.folders.values()).find(f =>
                    f.name === name && f.parentFolder === (this.currentFolderId || 'root')
                );
                if (existingFolder) {
                    nameInput.style.borderColor = '#dc3545';
                    this.showNotification('该文件夹名称已存在', 'error');
                    return;
                }

                // 重置输入框样式
                nameInput.style.borderColor = '#e1e5e9';

                // 显示创建中状态
                const originalText = createBtn.textContent;
                createBtn.textContent = '创建中...';
                createBtn.disabled = true;

                try {
                    // 检查是否为本地开发环境
                    const isLocalDev = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';

                    if (isLocalDev) {
                        // 本地开发环境：模拟成功创建文件夹
                        await new Promise(resolve => setTimeout(resolve, 1000)); // 模拟网络延迟

                        const newFolder = {
                            id: 'folder_' + Date.now(),
                            name: name,
                            color: colorInput.value,
                            parentFolder: this.currentFolderId === 'all' ? 'root' : (this.currentFolderId || 'root'),
                            fileCount: 0,
                            createdAt: new Date().toISOString()
                        };

                        this.folders.set(newFolder.id, newFolder);

                        // 保存新的文件夹到缓存
                        this.saveFoldersToCache(Array.from(this.folders.values()));

                        this.renderSidebar();
                        this.showNotification(`文件夹 "${name}" 创建成功！（本地演示模式）`, 'success');
                        this.closeFolderModal();
                    } else {
                        // 生产环境：调用真实API
                        const response = await fetch('/api/manage/folders-enhanced', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                name: name,
                                color: colorInput.value,
                                parentFolder: this.currentFolderId === 'all' ? 'root' : (this.currentFolderId || 'root')
                            })
                        });

                        if (response.ok) {
                            const newFolder = await response.json();
                            this.folders.set(newFolder.id, newFolder);

                            // 清除文件夹缓存，强制刷新
                            localStorage.removeItem('telegraph_folders_cache');

                            this.renderSidebar();
                            this.showNotification(`文件夹 "${name}" 创建成功！`, 'success');
                            this.closeFolderModal();
                        } else {
                            const error = await response.json();
                            this.showNotification('创建失败：' + (error.error || '未知错误'), 'error');
                        }
                    }
                } catch (error) {
                    console.error('创建文件夹失败:', error);
                    this.showNotification('创建失败：网络连接错误', 'error');
                } finally {
                    // 恢复按钮状态
                    createBtn.textContent = originalText;
                    createBtn.disabled = false;
                }
            }
        }

        // 启动应用
        window.imageViewer = new SimpleImageViewer();

        // 全局路由检查函数
        window.checkUrlRouting = function() {
            const path = window.location.pathname;
            const hash = window.location.hash;

            console.log('🔗 全局路由检查:', path, hash);

            // 检查是否是新建文件夹路由
            if (path.includes('/finder/new') || hash === '#new') {
                console.log('📁 检测到新建文件夹路由，自动打开新建文件夹模态框');

                // 查找新建文件夹按钮并点击
                const newFolderBtn = document.getElementById('newFolderBtn');
                if (newFolderBtn) {
                    newFolderBtn.click();
                    console.log('✅ 已点击新建文件夹按钮');
                } else {
                    console.log('❌ 找不到新建文件夹按钮');
                }

                // 清除URL中的路由标识
                if (path.includes('/finder/new')) {
                    window.history.replaceState({}, '', '/finder/');
                } else if (hash === '#new') {
                    window.history.replaceState({}, '', window.location.pathname);
                }
            }
        };

        // 页面加载完成后检查路由
        setTimeout(() => {
            const hash = window.location.hash;
            const path = window.location.pathname;

            console.log('🔗 检查URL路由:', path, hash);

            // 检查是否是新建文件夹路由
            if (path.includes('/finder/new') || hash === '#new') {
                console.log('📁 检测到新建文件夹路由，自动点击新建文件夹按钮');

                const newFolderBtn = document.getElementById('newFolderBtn');
                if (newFolderBtn) {
                    newFolderBtn.click();
                    console.log('✅ 已点击新建文件夹按钮');

                    // 清除URL中的路由标识
                    if (path.includes('/finder/new')) {
                        window.history.replaceState({}, '', '/finder/');
                    } else if (hash === '#new') {
                        window.history.replaceState({}, '', window.location.pathname);
                    }
                } else {
                    console.log('❌ 找不到新建文件夹按钮');
                }
            }
        }, 1500);

        // 点击模态框背景关闭
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                imageViewer.closeFolderModal();
            }
        });
    </script>
</body>
</html>
