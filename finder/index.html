<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegraph Finder - 文件管理器</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- 顶部工具栏 -->
    <header class="toolbar">
        <div class="toolbar-left">
            <button id="backBtn" class="btn-icon" title="返回">
                <i class="fas fa-arrow-left"></i>
            </button>
            <button id="forwardBtn" class="btn-icon" title="前进">
                <i class="fas fa-arrow-right"></i>
            </button>
            <div class="breadcrumb" id="breadcrumb">
                <span class="breadcrumb-item">全部文件</span>
            </div>
        </div>
        <div class="toolbar-right">
            <button id="viewModeBtn" class="btn-icon" title="切换视图">
                <i class="fas fa-th"></i>
            </button>
            <button id="refreshBtn" class="btn-secondary" title="刷新图片列表">
                <i class="fas fa-sync-alt"></i>
                刷新
            </button>
            <button id="uploadBtn" class="btn-primary">
                <i class="fas fa-upload"></i>
                上传图片
            </button>
        </div>
    </header>

    <!-- 主要内容区域 -->
    <main class="main-content">
        <!-- 侧边栏 -->
        <aside class="sidebar">
            <div class="sidebar-section">
                <h3>图片管理</h3>
                <ul class="nav-list">
                    <li class="nav-item active" data-path="/">
                        <i class="fas fa-images"></i>
                        <span>全部图片</span>
                    </li>
                    <li class="nav-item" data-path="/recent">
                        <i class="fas fa-clock"></i>
                        <span>最近上传</span>
                    </li>
                    <li class="nav-item" data-path="/favorites">
                        <i class="fas fa-star"></i>
                        <span>收藏夹</span>
                    </li>
                </ul>
            </div>

            <div class="sidebar-section">
                <h3>快速操作</h3>
                <ul class="nav-list">
                    <li class="nav-item action-item" data-action="refresh">
                        <i class="fas fa-sync-alt"></i>
                        <span>刷新列表</span>
                    </li>
                    <li class="nav-item action-item" data-action="clear-cache">
                        <i class="fas fa-broom"></i>
                        <span>清理缓存</span>
                    </li>
                </ul>
            </div>
        </aside>

        <!-- 文件显示区域 -->
        <section class="file-area">
            <!-- 加载状态 -->
            <div id="loadingState" class="loading-state">
                <div class="spinner"></div>
                <p>加载中...</p>
            </div>

            <!-- 空状态 -->
            <div id="emptyState" class="empty-state" style="display: none;">
                <div class="empty-icon">
                    <i class="fas fa-images"></i>
                </div>
                <h3>还没有图片</h3>
                <p>拖拽图片到这里或点击上传按钮开始使用</p>
                <button class="btn-primary" onclick="document.getElementById('fileInput').click()">
                    <i class="fas fa-upload"></i>
                    上传图片
                </button>
            </div>

            <!-- 文件网格 -->
            <div id="fileGrid" class="file-grid" style="display: none;">
                <!-- 动态生成的文件项 -->
            </div>

            <!-- 文件列表视图 -->
            <div id="fileList" class="file-list" style="display: none;">
                <table>
                    <thead>
                        <tr>
                            <th>名称</th>
                            <th>大小</th>
                            <th>类型</th>
                            <th>修改时间</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="fileListBody">
                        <!-- 动态生成的文件行 -->
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <!-- 隐藏的文件输入 -->
    <input type="file" id="fileInput" multiple style="display: none;">

    <!-- 上传进度模态框 -->
    <div id="uploadModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>文件上传</h3>
                <button class="modal-close" onclick="closeUploadModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="uploadProgress">
                    <!-- 动态生成的上传进度项 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 图片预览模态框 -->
    <div id="imagePreviewModal" class="modal" style="display: none;">
        <div class="modal-backdrop" onclick="imageFinder.closeImagePreview()"></div>
        <div class="image-preview-content">
            <div class="preview-header">
                <h3 id="previewImageName">图片预览</h3>
                <div class="preview-actions">
                    <button class="btn-icon" onclick="imageFinder.toggleFavorite()" id="favoriteBtn">
                        <i class="fas fa-star"></i>
                    </button>
                    <button class="btn-icon" onclick="imageFinder.downloadCurrentImage()">
                        <i class="fas fa-download"></i>
                    </button>
                    <button class="btn-icon" onclick="imageFinder.copyImageLink()">
                        <i class="fas fa-link"></i>
                    </button>
                    <button class="btn-icon" onclick="imageFinder.closeImagePreview()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="preview-body">
                <img id="previewImage" src="" alt="预览图片">
                <div class="preview-info">
                    <div class="info-item">
                        <span class="label">文件大小:</span>
                        <span id="previewSize">-</span>
                    </div>
                    <div class="info-item">
                        <span class="label">上传时间:</span>
                        <span id="previewDate">-</span>
                    </div>
                    <div class="info-item">
                        <span class="label">图片链接:</span>
                        <input type="text" id="previewUrl" readonly onclick="this.select()">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 右键菜单 - 简化版 -->
    <div id="contextMenu" class="context-menu" style="display: none;">
        <ul>
            <li class="menu-item" data-action="preview">
                <i class="fas fa-eye"></i>
                <span>预览</span>
            </li>
            <li class="menu-item" data-action="favorite">
                <i class="fas fa-star"></i>
                <span>收藏/取消收藏</span>
            </li>
            <li class="menu-item" data-action="download">
                <i class="fas fa-download"></i>
                <span>下载</span>
            </li>
            <li class="menu-item" data-action="copy">
                <i class="fas fa-link"></i>
                <span>复制链接</span>
            </li>
            <li class="separator"></li>
            <li class="menu-item danger" data-action="delete">
                <i class="fas fa-trash"></i>
                <span>删除</span>
            </li>
        </ul>
    </div>

    <!-- 通知容器 -->
    <div id="notifications" class="notifications"></div>

    <script>
        // 极简版Telegraph图片查看器 - 内联版本
        class SimpleImageViewer {
            constructor() {
                this.images = [];
                console.log('🚀 Simple Image Viewer 启动...');
                this.init();
            }

            async init() {
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', () => this.start());
                } else {
                    this.start();
                }
            }

            async start() {
                console.log('📸 开始加载图片...');
                this.hideLoading();
                this.bindEvents();
                await this.loadImages(true); // 首次加载强制刷新
                this.renderImages();
                this.startPeriodicCheck(); // 启动定期检查
                console.log('✅ 图片加载完成');
            }

            // 启动定期检查机制
            startPeriodicCheck() {
                // 每30秒检查一次更新
                setInterval(async () => {
                    await this.checkForUpdates();
                }, 30000);

                // 页面获得焦点时也检查更新
                window.addEventListener('focus', async () => {
                    console.log('🔍 页面获得焦点，检查更新...');
                    await this.checkForUpdates();
                });

                console.log('🔄 已启动定期检查机制');
            }

            hideLoading() {
                const loadingElement = document.querySelector('.loading-state');
                if (loadingElement) loadingElement.style.display = 'none';

                const fileArea = document.querySelector('.file-area');
                if (fileArea) fileArea.style.display = 'block';
            }

            bindEvents() {
                // 上传按钮
                const uploadBtn = document.getElementById('uploadBtn');
                if (uploadBtn) {
                    uploadBtn.addEventListener('click', () => {
                        const fileInput = document.getElementById('fileInput');
                        if (fileInput) fileInput.click();
                    });
                }

                // 刷新按钮
                const refreshBtn = document.getElementById('refreshBtn');
                if (refreshBtn) {
                    refreshBtn.addEventListener('click', async () => {
                        console.log('🔄 手动刷新图片列表...');
                        refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 刷新中...';
                        refreshBtn.disabled = true;

                        try {
                            await this.loadImages(true);
                            this.renderImages();
                            this.showSuccessMessage('图片列表已刷新！');
                        } finally {
                            refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> 刷新';
                            refreshBtn.disabled = false;
                        }
                    });
                }

                // 文件输入
                const fileInput = document.getElementById('fileInput');
                if (fileInput) {
                    fileInput.addEventListener('change', (e) => {
                        this.handleFileUpload(e.target.files);
                    });
                }
            }

            async loadImages(forceRefresh = false) {
                console.log('📸 加载图片列表...', forceRefresh ? '(强制刷新)' : '');

                try {
                    // 添加时间戳避免缓存
                    const timestamp = forceRefresh ? `?t=${Date.now()}` : '';
                    const response = await fetch(`/api/manage/list${timestamp}`, {
                        method: 'GET',
                        headers: {
                            'Cache-Control': 'no-cache',
                            'Pragma': 'no-cache'
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        this.images = this.filterImages(data);
                        console.log(`✅ 加载了 ${this.images.length} 张图片`);

                        // 保存到本地存储，用于跨浏览器同步检测
                        this.saveImageListToStorage();
                    } else {
                        throw new Error(`HTTP ${response.status}`);
                    }
                } catch (error) {
                    console.log('🎭 API不可用，使用演示数据');
                    this.images = this.getDemoImages();
                }
            }

            // 保存图片列表到本地存储
            saveImageListToStorage() {
                try {
                    const imageList = this.images.map(img => ({
                        id: img.id,
                        name: img.name,
                        size: img.size,
                        uploadDate: img.uploadDate
                    }));
                    localStorage.setItem('telegraph_image_list', JSON.stringify({
                        timestamp: Date.now(),
                        images: imageList
                    }));
                } catch (error) {
                    console.error('保存图片列表失败:', error);
                }
            }

            // 检查是否需要刷新（跨浏览器同步）
            async checkForUpdates() {
                try {
                    const stored = localStorage.getItem('telegraph_image_list');
                    if (!stored) return;

                    const { timestamp, images: storedImages } = JSON.parse(stored);
                    const currentImages = this.images.map(img => img.id).sort();
                    const storedImageIds = storedImages.map(img => img.id).sort();

                    // 如果图片列表不一致，强制刷新
                    if (JSON.stringify(currentImages) !== JSON.stringify(storedImageIds)) {
                        console.log('🔄 检测到图片列表变化，自动刷新...');
                        await this.loadImages(true);
                        this.renderImages();
                    }
                } catch (error) {
                    console.error('检查更新失败:', error);
                }
            }

            filterImages(files) {
                if (!Array.isArray(files)) return [];

                return files
                    .filter(file => this.isImageFile(file.name))
                    .map(file => ({
                        id: file.name,
                        name: file.metadata?.fileName || file.name,
                        size: file.metadata?.fileSize || 0,
                        url: `/file/${file.name}`,
                        uploadDate: new Date(file.metadata?.TimeStamp || Date.now())
                    }))
                    .sort((a, b) => b.uploadDate - a.uploadDate);
            }

            isImageFile(filename) {
                const imageExtensions = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg', 'bmp', 'ico'];
                const ext = filename.split('.').pop().toLowerCase();
                return imageExtensions.includes(ext);
            }

            getDemoImages() {
                return [
                    {
                        id: 'demo_1',
                        name: '演示图片1.jpg',
                        size: 1024000,
                        url: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iIzQyODVmNCIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmaWxsPSJ3aGl0ZSIgZm9udC1zaXplPSIxNiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPuekuuS+i+WbvueJhzE8L3RleHQ+PC9zdmc+',
                        uploadDate: new Date(Date.now() - 86400000)
                    },
                    {
                        id: 'demo_2',
                        name: '演示图片2.png',
                        size: 2048000,
                        url: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iIzM0Yzc1OSIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmaWxsPSJ3aGl0ZSIgZm9udC1zaXplPSIxNiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPuekuuS+i+WbvueJhzI8L3RleHQ+PC9zdmc+',
                        uploadDate: new Date(Date.now() - 172800000)
                    },
                    {
                        id: 'demo_3',
                        name: '演示图片3.jpg',
                        size: 1536000,
                        url: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2ZmOTUwMCIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmaWxsPSJ3aGl0ZSIgZm9udC1zaXplPSIxNiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPuekuuS+i+WbvueJhzM8L3RleHQ+PC9zdmc+',
                        uploadDate: new Date(Date.now() - 259200000)
                    }
                ];
            }

            renderImages() {
                const fileGrid = document.getElementById('fileGrid');
                const emptyState = document.getElementById('emptyState');

                if (!fileGrid) {
                    console.error('❌ 找不到fileGrid元素');
                    return;
                }

                if (this.images.length === 0) {
                    if (emptyState) emptyState.style.display = 'flex';
                    fileGrid.style.display = 'none';
                    return;
                }

                if (emptyState) emptyState.style.display = 'none';
                fileGrid.style.display = 'grid';

                fileGrid.innerHTML = this.images.map(image => `
                    <div class="file-item" data-image-id="${image.id}">
                        <div class="file-icon image">
                            <img src="${image.url}" alt="${image.name}" loading="lazy"
                                 style="width: 100%; height: 120px; object-fit: cover; border-radius: 8px;"
                                 onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iI2Y1ZjVmNSIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmaWxsPSIjOTk5IiBmb250LXNpemU9IjEyIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+5Zu+54mH5Yqg6L295aSx6LSlPC90ZXh0Pjwvc3ZnPg=='">
                        </div>
                        <div class="file-name" title="${image.name}">${image.name}</div>
                        <div class="file-size">${this.formatFileSize(image.size)}</div>
                    </div>
                `).join('');

                this.bindImageEvents();
                console.log(`✅ 渲染了 ${this.images.length} 张图片`);
            }

            bindImageEvents() {
                const fileItems = document.querySelectorAll('.file-item');
                fileItems.forEach(item => {
                    item.addEventListener('click', () => {
                        const imageId = item.dataset.imageId;
                        const image = this.images.find(img => img.id === imageId);
                        if (image) {
                            window.open(image.url, '_blank');
                        }
                    });

                    item.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        this.showContextMenu(e, item.dataset.imageId);
                    });
                });
            }

            showContextMenu(e, imageId) {
                const image = this.images.find(img => img.id === imageId);
                if (!image) return;

                // 创建右键菜单
                this.removeExistingContextMenu();

                const contextMenu = document.createElement('div');
                contextMenu.className = 'context-menu';
                contextMenu.style.cssText = `
                    position: fixed;
                    background: white;
                    border-radius: 8px;
                    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
                    border: 1px solid #e5e5e7;
                    padding: 4px 0;
                    min-width: 160px;
                    z-index: 1001;
                    left: ${e.pageX}px;
                    top: ${e.pageY}px;
                `;

                contextMenu.innerHTML = `
                    <div class="menu-item" data-action="copy" style="padding: 8px 16px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-link"></i>
                        <span>复制链接</span>
                    </div>
                    <div class="menu-item" data-action="download" style="padding: 8px 16px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-download"></i>
                        <span>下载图片</span>
                    </div>
                    <div style="height: 1px; background: #e5e5e7; margin: 4px 0;"></div>
                    <div class="menu-item" data-action="delete" style="padding: 8px 16px; cursor: pointer; display: flex; align-items: center; gap: 8px; color: #ff3b30;">
                        <i class="fas fa-trash"></i>
                        <span>删除图片</span>
                    </div>
                `;

                // 添加悬停效果和点击事件
                const menuItems = contextMenu.querySelectorAll('.menu-item');
                menuItems.forEach(item => {
                    item.addEventListener('mouseenter', () => {
                        item.style.background = '#f0f0f0';
                    });
                    item.addEventListener('mouseleave', () => {
                        item.style.background = 'transparent';
                    });

                    item.addEventListener('click', () => {
                        const action = item.dataset.action;
                        this.handleContextMenuAction(action, image, imageId);
                        this.removeExistingContextMenu();
                    });
                });

                document.body.appendChild(contextMenu);

                // 确保菜单不超出屏幕
                const rect = contextMenu.getBoundingClientRect();
                if (rect.right > window.innerWidth) {
                    contextMenu.style.left = (e.pageX - rect.width) + 'px';
                }
                if (rect.bottom > window.innerHeight) {
                    contextMenu.style.top = (e.pageY - rect.height) + 'px';
                }

                // 点击其他地方关闭菜单
                setTimeout(() => {
                    document.addEventListener('click', this.closeContextMenu.bind(this), { once: true });
                }, 0);
            }

            removeExistingContextMenu() {
                const existingMenu = document.querySelector('.context-menu');
                if (existingMenu) {
                    existingMenu.remove();
                }
            }

            closeContextMenu() {
                this.removeExistingContextMenu();
            }

            handleContextMenuAction(action, image, imageId) {
                switch(action) {
                    case 'copy':
                        this.copyToClipboard(window.location.origin + image.url);
                        break;
                    case 'download':
                        this.downloadImage(image);
                        break;
                    case 'delete':
                        this.deleteImage(imageId);
                        break;
                }
            }

            copyToClipboard(text) {
                navigator.clipboard.writeText(text).then(() => {
                    alert('链接已复制到剪贴板！');
                }).catch(() => {
                    prompt('请手动复制链接:', text);
                });
            }

            downloadImage(image) {
                const a = document.createElement('a');
                a.href = image.url;
                a.download = image.name;
                a.click();
            }

            async deleteImage(imageId) {
                const image = this.images.find(img => img.id === imageId);
                if (!image) return;

                if (!confirm(`确定要删除图片 "${image.name}" 吗？\n\n此操作不可撤销！`)) return;

                console.log('🗑️ 开始删除图片:', imageId);

                try {
                    const response = await fetch(`/api/manage/delete/${imageId}`, {
                        method: 'DELETE',
                        headers: {
                            'Cache-Control': 'no-cache',
                            'Pragma': 'no-cache'
                        }
                    });

                    if (response.ok) {
                        console.log('✅ 服务器删除成功');

                        // 显示成功消息
                        this.showSuccessMessage(`图片 "${image.name}" 删除成功！`);

                        // 等待1秒确保服务器处理完成
                        await new Promise(resolve => setTimeout(resolve, 1000));

                        // 强制从服务器重新加载图片列表
                        await this.loadImages(true);
                        this.renderImages();

                        console.log('🔄 图片列表已刷新');
                    } else {
                        const errorText = await response.text();
                        console.error('❌ 删除失败:', response.status, errorText);
                        alert(`删除失败: ${response.status} ${errorText}`);
                    }
                } catch (error) {
                    console.error('❌ 删除异常:', error);
                    alert('删除失败：' + error.message);
                }
            }

            handleFileUpload(files) {
                if (!files || files.length === 0) return;

                Array.from(files).forEach(file => {
                    if (this.isImageFile(file.name)) {
                        this.uploadImage(file);
                    } else {
                        alert(`${file.name} 不是支持的图片格式`);
                    }
                });
            }

            async uploadImage(file) {
                console.log('📤 开始上传图片:', file.name);

                const formData = new FormData();
                formData.append('file', file);

                try {
                    const response = await fetch('/upload', {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        const result = await response.json();
                        console.log('✅ 上传成功:', result);

                        // 显示成功消息
                        this.showSuccessMessage(`图片 "${file.name}" 上传成功！`);

                        // 等待1秒确保服务器处理完成
                        await new Promise(resolve => setTimeout(resolve, 1000));

                        // 强制刷新图片列表
                        await this.loadImages(true);
                        this.renderImages();

                        console.log('🔄 图片列表已刷新');
                    } else {
                        const errorText = await response.text();
                        console.error('❌ 上传失败:', response.status, errorText);
                        alert(`上传失败: ${response.status} ${errorText}`);
                    }
                } catch (error) {
                    console.error('❌ 上传异常:', error);
                    alert('上传失败：' + error.message);
                }
            }

            // 显示成功消息
            showSuccessMessage(message) {
                // 创建成功提示
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #34c759;
                    color: white;
                    padding: 12px 20px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(52, 199, 89, 0.3);
                    z-index: 10000;
                    font-weight: 500;
                `;
                notification.textContent = message;

                document.body.appendChild(notification);

                // 3秒后自动移除
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 3000);
            }

            formatFileSize(bytes) {
                if (bytes === 0) return '0 B';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
        }

        // 启动应用
        const imageViewer = new SimpleImageViewer();
    </script>
</body>
</html>
