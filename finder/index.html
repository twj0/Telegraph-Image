<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegraph Finder - æ–‡ä»¶ç®¡ç†å™¨</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- é¡¶éƒ¨å·¥å…·æ  -->
    <header class="toolbar">
        <div class="toolbar-left">
            <button id="backBtn" class="btn-icon" title="è¿”å›">
                <i class="fas fa-arrow-left"></i>
            </button>
            <button id="forwardBtn" class="btn-icon" title="å‰è¿›">
                <i class="fas fa-arrow-right"></i>
            </button>
            <div class="breadcrumb" id="breadcrumb">
                <span class="breadcrumb-item">å…¨éƒ¨æ–‡ä»¶</span>
            </div>
        </div>
        <div class="toolbar-right">
            <button id="viewModeBtn" class="btn-icon" title="åˆ‡æ¢è§†å›¾">
                <i class="fas fa-th"></i>
            </button>
            <button id="refreshBtn" class="btn-secondary" title="åˆ·æ–°å›¾ç‰‡åˆ—è¡¨">
                <i class="fas fa-sync-alt"></i>
                åˆ·æ–°
            </button>
            <button id="uploadBtn" class="btn-primary">
                <i class="fas fa-upload"></i>
                ä¸Šä¼ å›¾ç‰‡
            </button>
        </div>
    </header>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <main class="main-content">
        <!-- ä¾§è¾¹æ  -->
        <aside class="sidebar">
            <div class="sidebar-section">
                <h3>å›¾ç‰‡ç®¡ç†</h3>
                <ul class="nav-list">
                    <li class="nav-item active" data-path="/">
                        <i class="fas fa-images"></i>
                        <span>å…¨éƒ¨å›¾ç‰‡</span>
                    </li>
                    <li class="nav-item" data-path="/recent">
                        <i class="fas fa-clock"></i>
                        <span>æœ€è¿‘ä¸Šä¼ </span>
                    </li>
                    <li class="nav-item" data-path="/favorites">
                        <i class="fas fa-star"></i>
                        <span>æ”¶è—å¤¹</span>
                    </li>
                </ul>
            </div>

            <div class="sidebar-section">
                <h3>å¿«é€Ÿæ“ä½œ</h3>
                <ul class="nav-list">
                    <li class="nav-item action-item" data-action="refresh">
                        <i class="fas fa-sync-alt"></i>
                        <span>åˆ·æ–°åˆ—è¡¨</span>
                    </li>
                    <li class="nav-item action-item" data-action="clear-cache">
                        <i class="fas fa-broom"></i>
                        <span>æ¸…ç†ç¼“å­˜</span>
                    </li>
                </ul>
            </div>
        </aside>

        <!-- æ–‡ä»¶æ˜¾ç¤ºåŒºåŸŸ -->
        <section class="file-area">
            <!-- åŠ è½½çŠ¶æ€ -->
            <div id="loadingState" class="loading-state">
                <div class="spinner"></div>
                <p>åŠ è½½ä¸­...</p>
            </div>

            <!-- ç©ºçŠ¶æ€ -->
            <div id="emptyState" class="empty-state" style="display: none;">
                <div class="empty-icon">
                    <i class="fas fa-images"></i>
                </div>
                <h3>è¿˜æ²¡æœ‰å›¾ç‰‡</h3>
                <p>æ‹–æ‹½å›¾ç‰‡åˆ°è¿™é‡Œæˆ–ç‚¹å‡»ä¸Šä¼ æŒ‰é’®å¼€å§‹ä½¿ç”¨</p>
                <button class="btn-primary" onclick="document.getElementById('fileInput').click()">
                    <i class="fas fa-upload"></i>
                    ä¸Šä¼ å›¾ç‰‡
                </button>
            </div>

            <!-- æ–‡ä»¶ç½‘æ ¼ -->
            <div id="fileGrid" class="file-grid" style="display: none;">
                <!-- åŠ¨æ€ç”Ÿæˆçš„æ–‡ä»¶é¡¹ -->
            </div>

            <!-- æ–‡ä»¶åˆ—è¡¨è§†å›¾ -->
            <div id="fileList" class="file-list" style="display: none;">
                <table>
                    <thead>
                        <tr>
                            <th>åç§°</th>
                            <th>å¤§å°</th>
                            <th>ç±»å‹</th>
                            <th>ä¿®æ”¹æ—¶é—´</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="fileListBody">
                        <!-- åŠ¨æ€ç”Ÿæˆçš„æ–‡ä»¶è¡Œ -->
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <!-- éšè—çš„æ–‡ä»¶è¾“å…¥ -->
    <input type="file" id="fileInput" multiple style="display: none;">

    <!-- ä¸Šä¼ è¿›åº¦æ¨¡æ€æ¡† -->
    <div id="uploadModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>æ–‡ä»¶ä¸Šä¼ </h3>
                <button class="modal-close" onclick="closeUploadModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="uploadProgress">
                    <!-- åŠ¨æ€ç”Ÿæˆçš„ä¸Šä¼ è¿›åº¦é¡¹ -->
                </div>
            </div>
        </div>
    </div>

    <!-- å›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡† -->
    <div id="imagePreviewModal" class="modal" style="display: none;">
        <div class="modal-backdrop" onclick="imageFinder.closeImagePreview()"></div>
        <div class="image-preview-content">
            <div class="preview-header">
                <h3 id="previewImageName">å›¾ç‰‡é¢„è§ˆ</h3>
                <div class="preview-actions">
                    <button class="btn-icon" onclick="imageFinder.toggleFavorite()" id="favoriteBtn">
                        <i class="fas fa-star"></i>
                    </button>
                    <button class="btn-icon" onclick="imageFinder.downloadCurrentImage()">
                        <i class="fas fa-download"></i>
                    </button>
                    <button class="btn-icon" onclick="imageFinder.copyImageLink()">
                        <i class="fas fa-link"></i>
                    </button>
                    <button class="btn-icon" onclick="imageFinder.closeImagePreview()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="preview-body">
                <img id="previewImage" src="" alt="é¢„è§ˆå›¾ç‰‡">
                <div class="preview-info">
                    <div class="info-item">
                        <span class="label">æ–‡ä»¶å¤§å°:</span>
                        <span id="previewSize">-</span>
                    </div>
                    <div class="info-item">
                        <span class="label">ä¸Šä¼ æ—¶é—´:</span>
                        <span id="previewDate">-</span>
                    </div>
                    <div class="info-item">
                        <span class="label">å›¾ç‰‡é“¾æ¥:</span>
                        <input type="text" id="previewUrl" readonly onclick="this.select()">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å³é”®èœå• - ç®€åŒ–ç‰ˆ -->
    <div id="contextMenu" class="context-menu" style="display: none;">
        <ul>
            <li class="menu-item" data-action="preview">
                <i class="fas fa-eye"></i>
                <span>é¢„è§ˆ</span>
            </li>
            <li class="menu-item" data-action="favorite">
                <i class="fas fa-star"></i>
                <span>æ”¶è—/å–æ¶ˆæ”¶è—</span>
            </li>
            <li class="menu-item" data-action="download">
                <i class="fas fa-download"></i>
                <span>ä¸‹è½½</span>
            </li>
            <li class="menu-item" data-action="copy">
                <i class="fas fa-link"></i>
                <span>å¤åˆ¶é“¾æ¥</span>
            </li>
            <li class="separator"></li>
            <li class="menu-item danger" data-action="delete">
                <i class="fas fa-trash"></i>
                <span>åˆ é™¤</span>
            </li>
        </ul>
    </div>

    <!-- é€šçŸ¥å®¹å™¨ -->
    <div id="notifications" class="notifications"></div>

    <script>
        // æç®€ç‰ˆTelegraphå›¾ç‰‡æŸ¥çœ‹å™¨ - å†…è”ç‰ˆæœ¬
        class SimpleImageViewer {
            constructor() {
                this.images = [];
                console.log('ğŸš€ Simple Image Viewer å¯åŠ¨...');
                this.init();
            }

            async init() {
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', () => this.start());
                } else {
                    this.start();
                }
            }

            async start() {
                console.log('ğŸ“¸ å¼€å§‹åŠ è½½å›¾ç‰‡...');
                this.hideLoading();
                this.bindEvents();
                await this.loadImages(true); // é¦–æ¬¡åŠ è½½å¼ºåˆ¶åˆ·æ–°
                this.renderImages();
                this.startPeriodicCheck(); // å¯åŠ¨å®šæœŸæ£€æŸ¥
                console.log('âœ… å›¾ç‰‡åŠ è½½å®Œæˆ');
            }

            // å¯åŠ¨å®šæœŸæ£€æŸ¥æœºåˆ¶
            startPeriodicCheck() {
                // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡æ›´æ–°
                setInterval(async () => {
                    await this.checkForUpdates();
                }, 30000);

                // é¡µé¢è·å¾—ç„¦ç‚¹æ—¶ä¹Ÿæ£€æŸ¥æ›´æ–°
                window.addEventListener('focus', async () => {
                    console.log('ğŸ” é¡µé¢è·å¾—ç„¦ç‚¹ï¼Œæ£€æŸ¥æ›´æ–°...');
                    await this.checkForUpdates();
                });

                console.log('ğŸ”„ å·²å¯åŠ¨å®šæœŸæ£€æŸ¥æœºåˆ¶');
            }

            hideLoading() {
                const loadingElement = document.querySelector('.loading-state');
                if (loadingElement) loadingElement.style.display = 'none';

                const fileArea = document.querySelector('.file-area');
                if (fileArea) fileArea.style.display = 'block';
            }

            bindEvents() {
                // ä¸Šä¼ æŒ‰é’®
                const uploadBtn = document.getElementById('uploadBtn');
                if (uploadBtn) {
                    uploadBtn.addEventListener('click', () => {
                        const fileInput = document.getElementById('fileInput');
                        if (fileInput) fileInput.click();
                    });
                }

                // åˆ·æ–°æŒ‰é’®
                const refreshBtn = document.getElementById('refreshBtn');
                if (refreshBtn) {
                    refreshBtn.addEventListener('click', async () => {
                        console.log('ğŸ”„ æ‰‹åŠ¨åˆ·æ–°å›¾ç‰‡åˆ—è¡¨...');
                        refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> åˆ·æ–°ä¸­...';
                        refreshBtn.disabled = true;

                        try {
                            await this.loadImages(true);
                            this.renderImages();
                            this.showSuccessMessage('å›¾ç‰‡åˆ—è¡¨å·²åˆ·æ–°ï¼');
                        } finally {
                            refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> åˆ·æ–°';
                            refreshBtn.disabled = false;
                        }
                    });
                }

                // æ–‡ä»¶è¾“å…¥
                const fileInput = document.getElementById('fileInput');
                if (fileInput) {
                    fileInput.addEventListener('change', (e) => {
                        this.handleFileUpload(e.target.files);
                    });
                }
            }

            async loadImages(forceRefresh = false) {
                console.log('ğŸ“¸ åŠ è½½å›¾ç‰‡åˆ—è¡¨...', forceRefresh ? '(å¼ºåˆ¶åˆ·æ–°)' : '');

                try {
                    // æ·»åŠ æ—¶é—´æˆ³é¿å…ç¼“å­˜
                    const timestamp = forceRefresh ? `?t=${Date.now()}` : '';
                    const response = await fetch(`/api/manage/list${timestamp}`, {
                        method: 'GET',
                        headers: {
                            'Cache-Control': 'no-cache',
                            'Pragma': 'no-cache'
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        this.images = this.filterImages(data);
                        console.log(`âœ… åŠ è½½äº† ${this.images.length} å¼ å›¾ç‰‡`);

                        // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ï¼Œç”¨äºè·¨æµè§ˆå™¨åŒæ­¥æ£€æµ‹
                        this.saveImageListToStorage();
                    } else {
                        throw new Error(`HTTP ${response.status}`);
                    }
                } catch (error) {
                    console.log('ğŸ­ APIä¸å¯ç”¨ï¼Œä½¿ç”¨æ¼”ç¤ºæ•°æ®');
                    this.images = this.getDemoImages();
                }
            }

            // ä¿å­˜å›¾ç‰‡åˆ—è¡¨åˆ°æœ¬åœ°å­˜å‚¨
            saveImageListToStorage() {
                try {
                    const imageList = this.images.map(img => ({
                        id: img.id,
                        name: img.name,
                        size: img.size,
                        uploadDate: img.uploadDate
                    }));
                    localStorage.setItem('telegraph_image_list', JSON.stringify({
                        timestamp: Date.now(),
                        images: imageList
                    }));
                } catch (error) {
                    console.error('ä¿å­˜å›¾ç‰‡åˆ—è¡¨å¤±è´¥:', error);
                }
            }

            // æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ·æ–°ï¼ˆè·¨æµè§ˆå™¨åŒæ­¥ï¼‰
            async checkForUpdates() {
                try {
                    const stored = localStorage.getItem('telegraph_image_list');
                    if (!stored) return;

                    const { timestamp, images: storedImages } = JSON.parse(stored);
                    const currentImages = this.images.map(img => img.id).sort();
                    const storedImageIds = storedImages.map(img => img.id).sort();

                    // å¦‚æœå›¾ç‰‡åˆ—è¡¨ä¸ä¸€è‡´ï¼Œå¼ºåˆ¶åˆ·æ–°
                    if (JSON.stringify(currentImages) !== JSON.stringify(storedImageIds)) {
                        console.log('ğŸ”„ æ£€æµ‹åˆ°å›¾ç‰‡åˆ—è¡¨å˜åŒ–ï¼Œè‡ªåŠ¨åˆ·æ–°...');
                        await this.loadImages(true);
                        this.renderImages();
                    }
                } catch (error) {
                    console.error('æ£€æŸ¥æ›´æ–°å¤±è´¥:', error);
                }
            }

            filterImages(files) {
                if (!Array.isArray(files)) return [];

                return files
                    .filter(file => this.isImageFile(file.name))
                    .map(file => ({
                        id: file.name,
                        name: file.metadata?.fileName || file.name,
                        size: file.metadata?.fileSize || 0,
                        url: `/file/${file.name}`,
                        uploadDate: new Date(file.metadata?.TimeStamp || Date.now())
                    }))
                    .sort((a, b) => b.uploadDate - a.uploadDate);
            }

            isImageFile(filename) {
                const imageExtensions = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg', 'bmp', 'ico'];
                const ext = filename.split('.').pop().toLowerCase();
                return imageExtensions.includes(ext);
            }

            getDemoImages() {
                return [
                    {
                        id: 'demo_1',
                        name: 'æ¼”ç¤ºå›¾ç‰‡1.jpg',
                        size: 1024000,
                        url: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iIzQyODVmNCIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmaWxsPSJ3aGl0ZSIgZm9udC1zaXplPSIxNiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPuekuuS+i+WbvueJhzE8L3RleHQ+PC9zdmc+',
                        uploadDate: new Date(Date.now() - 86400000)
                    },
                    {
                        id: 'demo_2',
                        name: 'æ¼”ç¤ºå›¾ç‰‡2.png',
                        size: 2048000,
                        url: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iIzM0Yzc1OSIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmaWxsPSJ3aGl0ZSIgZm9udC1zaXplPSIxNiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPuekuuS+i+WbvueJhzI8L3RleHQ+PC9zdmc+',
                        uploadDate: new Date(Date.now() - 172800000)
                    },
                    {
                        id: 'demo_3',
                        name: 'æ¼”ç¤ºå›¾ç‰‡3.jpg',
                        size: 1536000,
                        url: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2ZmOTUwMCIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmaWxsPSJ3aGl0ZSIgZm9udC1zaXplPSIxNiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPuekuuS+i+WbvueJhzM8L3RleHQ+PC9zdmc+',
                        uploadDate: new Date(Date.now() - 259200000)
                    }
                ];
            }

            renderImages() {
                const fileGrid = document.getElementById('fileGrid');
                const emptyState = document.getElementById('emptyState');

                if (!fileGrid) {
                    console.error('âŒ æ‰¾ä¸åˆ°fileGridå…ƒç´ ');
                    return;
                }

                if (this.images.length === 0) {
                    if (emptyState) emptyState.style.display = 'flex';
                    fileGrid.style.display = 'none';
                    return;
                }

                if (emptyState) emptyState.style.display = 'none';
                fileGrid.style.display = 'grid';

                fileGrid.innerHTML = this.images.map(image => `
                    <div class="file-item" data-image-id="${image.id}">
                        <div class="file-icon image">
                            <img src="${image.url}" alt="${image.name}" loading="lazy"
                                 style="width: 100%; height: 120px; object-fit: cover; border-radius: 8px;"
                                 onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iI2Y1ZjVmNSIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmaWxsPSIjOTk5IiBmb250LXNpemU9IjEyIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+5Zu+54mH5Yqg6L295aSx6LSlPC90ZXh0Pjwvc3ZnPg=='">
                        </div>
                        <div class="file-name" title="${image.name}">${image.name}</div>
                        <div class="file-size">${this.formatFileSize(image.size)}</div>
                    </div>
                `).join('');

                this.bindImageEvents();
                console.log(`âœ… æ¸²æŸ“äº† ${this.images.length} å¼ å›¾ç‰‡`);
            }

            bindImageEvents() {
                const fileItems = document.querySelectorAll('.file-item');
                fileItems.forEach(item => {
                    item.addEventListener('click', () => {
                        const imageId = item.dataset.imageId;
                        const image = this.images.find(img => img.id === imageId);
                        if (image) {
                            window.open(image.url, '_blank');
                        }
                    });

                    item.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        this.showContextMenu(e, item.dataset.imageId);
                    });
                });
            }

            showContextMenu(e, imageId) {
                const image = this.images.find(img => img.id === imageId);
                if (!image) return;

                // åˆ›å»ºå³é”®èœå•
                this.removeExistingContextMenu();

                const contextMenu = document.createElement('div');
                contextMenu.className = 'context-menu';
                contextMenu.style.cssText = `
                    position: fixed;
                    background: white;
                    border-radius: 8px;
                    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
                    border: 1px solid #e5e5e7;
                    padding: 4px 0;
                    min-width: 160px;
                    z-index: 1001;
                    left: ${e.pageX}px;
                    top: ${e.pageY}px;
                `;

                contextMenu.innerHTML = `
                    <div class="menu-item" data-action="copy" style="padding: 8px 16px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-link"></i>
                        <span>å¤åˆ¶é“¾æ¥</span>
                    </div>
                    <div class="menu-item" data-action="download" style="padding: 8px 16px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-download"></i>
                        <span>ä¸‹è½½å›¾ç‰‡</span>
                    </div>
                    <div style="height: 1px; background: #e5e5e7; margin: 4px 0;"></div>
                    <div class="menu-item" data-action="delete" style="padding: 8px 16px; cursor: pointer; display: flex; align-items: center; gap: 8px; color: #ff3b30;">
                        <i class="fas fa-trash"></i>
                        <span>åˆ é™¤å›¾ç‰‡</span>
                    </div>
                `;

                // æ·»åŠ æ‚¬åœæ•ˆæœå’Œç‚¹å‡»äº‹ä»¶
                const menuItems = contextMenu.querySelectorAll('.menu-item');
                menuItems.forEach(item => {
                    item.addEventListener('mouseenter', () => {
                        item.style.background = '#f0f0f0';
                    });
                    item.addEventListener('mouseleave', () => {
                        item.style.background = 'transparent';
                    });

                    item.addEventListener('click', () => {
                        const action = item.dataset.action;
                        this.handleContextMenuAction(action, image, imageId);
                        this.removeExistingContextMenu();
                    });
                });

                document.body.appendChild(contextMenu);

                // ç¡®ä¿èœå•ä¸è¶…å‡ºå±å¹•
                const rect = contextMenu.getBoundingClientRect();
                if (rect.right > window.innerWidth) {
                    contextMenu.style.left = (e.pageX - rect.width) + 'px';
                }
                if (rect.bottom > window.innerHeight) {
                    contextMenu.style.top = (e.pageY - rect.height) + 'px';
                }

                // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­èœå•
                setTimeout(() => {
                    document.addEventListener('click', this.closeContextMenu.bind(this), { once: true });
                }, 0);
            }

            removeExistingContextMenu() {
                const existingMenu = document.querySelector('.context-menu');
                if (existingMenu) {
                    existingMenu.remove();
                }
            }

            closeContextMenu() {
                this.removeExistingContextMenu();
            }

            handleContextMenuAction(action, image, imageId) {
                switch(action) {
                    case 'copy':
                        this.copyToClipboard(window.location.origin + image.url);
                        break;
                    case 'download':
                        this.downloadImage(image);
                        break;
                    case 'delete':
                        this.deleteImage(imageId);
                        break;
                }
            }

            copyToClipboard(text) {
                navigator.clipboard.writeText(text).then(() => {
                    alert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
                }).catch(() => {
                    prompt('è¯·æ‰‹åŠ¨å¤åˆ¶é“¾æ¥:', text);
                });
            }

            downloadImage(image) {
                const a = document.createElement('a');
                a.href = image.url;
                a.download = image.name;
                a.click();
            }

            async deleteImage(imageId) {
                const image = this.images.find(img => img.id === imageId);
                if (!image) return;

                if (!confirm(`ç¡®å®šè¦åˆ é™¤å›¾ç‰‡ "${image.name}" å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) return;

                console.log('ğŸ—‘ï¸ å¼€å§‹åˆ é™¤å›¾ç‰‡:', imageId);

                try {
                    const response = await fetch(`/api/manage/delete/${imageId}`, {
                        method: 'DELETE',
                        headers: {
                            'Cache-Control': 'no-cache',
                            'Pragma': 'no-cache'
                        }
                    });

                    if (response.ok) {
                        console.log('âœ… æœåŠ¡å™¨åˆ é™¤æˆåŠŸ');

                        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                        this.showSuccessMessage(`å›¾ç‰‡ "${image.name}" åˆ é™¤æˆåŠŸï¼`);

                        // ç­‰å¾…1ç§’ç¡®ä¿æœåŠ¡å™¨å¤„ç†å®Œæˆ
                        await new Promise(resolve => setTimeout(resolve, 1000));

                        // å¼ºåˆ¶ä»æœåŠ¡å™¨é‡æ–°åŠ è½½å›¾ç‰‡åˆ—è¡¨
                        await this.loadImages(true);
                        this.renderImages();

                        console.log('ğŸ”„ å›¾ç‰‡åˆ—è¡¨å·²åˆ·æ–°');
                    } else {
                        const errorText = await response.text();
                        console.error('âŒ åˆ é™¤å¤±è´¥:', response.status, errorText);
                        alert(`åˆ é™¤å¤±è´¥: ${response.status} ${errorText}`);
                    }
                } catch (error) {
                    console.error('âŒ åˆ é™¤å¼‚å¸¸:', error);
                    alert('åˆ é™¤å¤±è´¥ï¼š' + error.message);
                }
            }

            handleFileUpload(files) {
                if (!files || files.length === 0) return;

                Array.from(files).forEach(file => {
                    if (this.isImageFile(file.name)) {
                        this.uploadImage(file);
                    } else {
                        alert(`${file.name} ä¸æ˜¯æ”¯æŒçš„å›¾ç‰‡æ ¼å¼`);
                    }
                });
            }

            async uploadImage(file) {
                console.log('ğŸ“¤ å¼€å§‹ä¸Šä¼ å›¾ç‰‡:', file.name);

                const formData = new FormData();
                formData.append('file', file);

                try {
                    const response = await fetch('/upload', {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        const result = await response.json();
                        console.log('âœ… ä¸Šä¼ æˆåŠŸ:', result);

                        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                        this.showSuccessMessage(`å›¾ç‰‡ "${file.name}" ä¸Šä¼ æˆåŠŸï¼`);

                        // ç­‰å¾…1ç§’ç¡®ä¿æœåŠ¡å™¨å¤„ç†å®Œæˆ
                        await new Promise(resolve => setTimeout(resolve, 1000));

                        // å¼ºåˆ¶åˆ·æ–°å›¾ç‰‡åˆ—è¡¨
                        await this.loadImages(true);
                        this.renderImages();

                        console.log('ğŸ”„ å›¾ç‰‡åˆ—è¡¨å·²åˆ·æ–°');
                    } else {
                        const errorText = await response.text();
                        console.error('âŒ ä¸Šä¼ å¤±è´¥:', response.status, errorText);
                        alert(`ä¸Šä¼ å¤±è´¥: ${response.status} ${errorText}`);
                    }
                } catch (error) {
                    console.error('âŒ ä¸Šä¼ å¼‚å¸¸:', error);
                    alert('ä¸Šä¼ å¤±è´¥ï¼š' + error.message);
                }
            }

            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            showSuccessMessage(message) {
                // åˆ›å»ºæˆåŠŸæç¤º
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #34c759;
                    color: white;
                    padding: 12px 20px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(52, 199, 89, 0.3);
                    z-index: 10000;
                    font-weight: 500;
                `;
                notification.textContent = message;

                document.body.appendChild(notification);

                // 3ç§’åè‡ªåŠ¨ç§»é™¤
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 3000);
            }

            formatFileSize(bytes) {
                if (bytes === 0) return '0 B';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
        }

        // å¯åŠ¨åº”ç”¨
        const imageViewer = new SimpleImageViewer();
    </script>
</body>
</html>
