<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegraph Finder - 文件管理</title>
    
    <!-- Element UI CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/element-ui@2.15.3/lib/theme-chalk/index.css">
    
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .finder-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .finder-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .finder-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .file-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .file-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }

        .file-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        }

        .file-preview {
            width: 100%;
            height: 120px;
            background: #f5f5f5;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            overflow: hidden;
        }

        .file-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }

        .file-icon {
            font-size: 48px;
            color: #909399;
        }

        .file-info {
            text-align: center;
        }

        .file-name {
            font-weight: 600;
            margin-bottom: 5px;
            word-break: break-all;
        }

        .file-meta {
            font-size: 12px;
            color: #909399;
            margin-bottom: 10px;
        }

        .file-actions {
            display: flex;
            justify-content: center;
            gap: 5px;
        }

        .loading-container {
            text-align: center;
            padding: 40px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #909399;
        }

        .empty-state i {
            font-size: 64px;
            margin-bottom: 20px;
            display: block;
        }

        .stats-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .stats-info {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            color: #606266;
        }

        @media (max-width: 768px) {
            .finder-container {
                padding: 10px;
            }
            
            .file-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                gap: 15px;
            }
            
            .stats-bar {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="finder-container">
            <!-- 头部 -->
            <div class="finder-header">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h1 style="margin: 0; color: #2c3e50;">
                            <i class="el-icon-folder-opened"></i>
                            Telegraph Finder
                        </h1>
                        <p style="margin: 5px 0 0 0; color: #7f8c8d;">文件管理系统</p>
                    </div>
                    <div>
                        <el-button type="primary" icon="el-icon-refresh" @click="loadFiles" :loading="loading">
                            刷新
                        </el-button>
                        <el-button type="info" icon="el-icon-back" @click="goBack">
                            返回管理
                        </el-button>
                    </div>
                </div>
            </div>

            <!-- 内容区域 -->
            <div class="finder-content">
                <!-- 统计栏 -->
                <div class="stats-bar">
                    <div class="stats-info">
                        <div class="stat-item">
                            <i class="el-icon-document"></i>
                            <span>总文件: {{ totalFiles }}</span>
                        </div>
                        <div class="stat-item">
                            <i class="el-icon-star-on" style="color: #f39c12;"></i>
                            <span>收藏: {{ favoriteFiles }}</span>
                        </div>
                        <div class="stat-item">
                            <i class="el-icon-time"></i>
                            <span>最后更新: {{ lastUpdate }}</span>
                        </div>
                    </div>
                    <div>
                        <el-input
                            v-model="searchQuery"
                            placeholder="搜索文件..."
                            prefix-icon="el-icon-search"
                            style="width: 200px;"
                            @input="filterFiles"
                        ></el-input>
                    </div>
                </div>

                <!-- 加载状态 -->
                <div v-if="loading" class="loading-container">
                    <el-loading-spinner></el-loading-spinner>
                    <p>正在加载文件列表...</p>
                </div>

                <!-- 空状态 -->
                <div v-else-if="filteredFiles.length === 0" class="empty-state">
                    <i class="el-icon-folder-opened"></i>
                    <h3>{{ searchQuery ? '没有找到匹配的文件' : '暂无文件' }}</h3>
                    <p>{{ searchQuery ? '尝试使用其他关键词搜索' : '上传一些文件开始使用吧' }}</p>
                </div>

                <!-- 文件网格 -->
                <div v-else class="file-grid">
                    <div 
                        v-for="file in filteredFiles" 
                        :key="file.name" 
                        class="file-card"
                        @click="previewFile(file)"
                    >
                        <!-- 文件预览 -->
                        <div class="file-preview">
                            <img 
                                v-if="isImage(file)" 
                                :src="file.metadata.url" 
                                :alt="file.metadata.fileName"
                                @error="handleImageError"
                            />
                            <i v-else :class="getFileIcon(file)" class="file-icon"></i>
                        </div>

                        <!-- 文件信息 -->
                        <div class="file-info">
                            <div class="file-name">{{ file.metadata.fileName }}</div>
                            <div class="file-meta">
                                {{ formatFileSize(file.metadata.fileSize) }} • 
                                {{ formatDate(file.metadata.TimeStamp) }}
                            </div>
                            
                            <!-- 操作按钮 -->
                            <div class="file-actions" @click.stop>
                                <el-button 
                                    :type="file.metadata.liked ? 'warning' : 'info'"
                                    :icon="file.metadata.liked ? 'el-icon-star-on' : 'el-icon-star-off'"
                                    size="mini"
                                    circle
                                    @click="toggleFavorite(file)"
                                ></el-button>
                                
                                <el-button 
                                    type="primary" 
                                    icon="el-icon-edit" 
                                    size="mini"
                                    circle
                                    @click="renameFile(file)"
                                ></el-button>
                                
                                <el-button 
                                    type="success" 
                                    icon="el-icon-download" 
                                    size="mini"
                                    circle
                                    @click="downloadFile(file)"
                                ></el-button>
                                
                                <el-button 
                                    type="danger" 
                                    icon="el-icon-delete" 
                                    size="mini"
                                    circle
                                    @click="deleteFile(file)"
                                ></el-button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 重命名对话框 -->
        <el-dialog
            title="重命名文件"
            :visible.sync="renameDialog.visible"
            width="400px"
        >
            <el-form>
                <el-form-item label="文件名">
                    <el-input
                        v-model="renameDialog.newName"
                        placeholder="请输入新的文件名"
                        @keyup.enter.native="confirmRename"
                    ></el-input>
                </el-form-item>
            </el-form>
            <div slot="footer">
                <el-button @click="renameDialog.visible = false">取消</el-button>
                <el-button type="primary" @click="confirmRename" :loading="renameDialog.loading">
                    确定
                </el-button>
            </div>
        </el-dialog>
    </div>

    <!-- Vue.js 和 Element UI -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/element-ui@2.15.3/lib/index.js"></script>

    <script>
        new Vue({
            el: '#app',
            data() {
                return {
                    loading: false,
                    files: [],
                    filteredFiles: [],
                    searchQuery: '',
                    renameDialog: {
                        visible: false,
                        loading: false,
                        file: null,
                        newName: ''
                    }
                };
            },
            computed: {
                totalFiles() {
                    return this.files.length;
                },
                favoriteFiles() {
                    return this.files.filter(f => f.metadata.liked).length;
                },
                lastUpdate() {
                    if (this.files.length === 0) return '暂无';
                    const latest = Math.max(...this.files.map(f => f.metadata.TimeStamp));
                    return this.formatDate(latest);
                }
            },
            mounted() {
                this.loadFiles();
            },
            methods: {
                // 加载文件列表
                async loadFiles() {
                    this.loading = true;
                    try {
                        const response = await fetch('/api/finder/list', {
                            credentials: 'include'
                        });

                        if (response.ok) {
                            this.files = await response.json();
                            this.filterFiles();
                        } else if (response.status === 401) {
                            this.$message.error('认证失败，请重新登录');
                            this.redirectToLogin();
                        } else {
                            throw new Error('加载失败');
                        }
                    } catch (error) {
                        console.error('加载文件列表失败:', error);
                        this.$message.error('加载文件列表失败');
                    } finally {
                        this.loading = false;
                    }
                },

                // 过滤文件
                filterFiles() {
                    if (!this.searchQuery.trim()) {
                        this.filteredFiles = [...this.files];
                    } else {
                        const query = this.searchQuery.toLowerCase();
                        this.filteredFiles = this.files.filter(file =>
                            file.metadata.fileName.toLowerCase().includes(query)
                        );
                    }
                },

                // 判断是否为图片
                isImage(file) {
                    const imageTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
                    return imageTypes.includes(file.metadata.mimeType);
                },

                // 获取文件图标
                getFileIcon(file) {
                    const mimeType = file.metadata.mimeType || '';
                    if (mimeType.startsWith('image/')) return 'el-icon-picture';
                    if (mimeType.startsWith('video/')) return 'el-icon-video-camera';
                    if (mimeType.startsWith('audio/')) return 'el-icon-headset';
                    if (mimeType.includes('pdf')) return 'el-icon-document';
                    if (mimeType.includes('text')) return 'el-icon-document';
                    return 'el-icon-document';
                },

                // 格式化文件大小
                formatFileSize(bytes) {
                    if (bytes === 0) return '0 B';
                    const k = 1024;
                    const sizes = ['B', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                },

                // 格式化日期
                formatDate(timestamp) {
                    const date = new Date(timestamp);
                    return date.toLocaleDateString('zh-CN') + ' ' + date.toLocaleTimeString('zh-CN');
                },

                // 预览文件
                previewFile(file) {
                    if (file.metadata.url) {
                        window.open(file.metadata.url, '_blank');
                    } else {
                        this.$message.info('文件预览不可用');
                    }
                },

                // 下载文件
                downloadFile(file) {
                    if (file.metadata.url) {
                        const link = document.createElement('a');
                        link.href = file.metadata.url;
                        link.download = file.metadata.fileName;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    } else {
                        this.$message.error('下载链接不可用');
                    }
                },

                // 切换收藏状态
                async toggleFavorite(file) {
                    try {
                        const response = await fetch(`/api/finder/favorite/${file.name}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            credentials: 'include',
                            body: JSON.stringify({
                                liked: !file.metadata.liked
                            })
                        });

                        if (response.ok) {
                            file.metadata.liked = !file.metadata.liked;
                            this.$message.success(file.metadata.liked ? '已添加到收藏' : '已取消收藏');
                        } else {
                            throw new Error('操作失败');
                        }
                    } catch (error) {
                        console.error('切换收藏状态失败:', error);
                        this.$message.error('操作失败');
                    }
                },

                // 重命名文件
                renameFile(file) {
                    this.renameDialog.file = file;
                    this.renameDialog.newName = file.metadata.fileName;
                    this.renameDialog.visible = true;
                },

                // 确认重命名
                async confirmRename() {
                    if (!this.renameDialog.newName.trim()) {
                        this.$message.error('文件名不能为空');
                        return;
                    }

                    this.renameDialog.loading = true;
                    try {
                        const response = await fetch(`/api/finder/rename/${this.renameDialog.file.name}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            credentials: 'include',
                            body: JSON.stringify({
                                newName: this.renameDialog.newName.trim()
                            })
                        });

                        if (response.ok) {
                            this.renameDialog.file.metadata.fileName = this.renameDialog.newName.trim();
                            this.renameDialog.visible = false;
                            this.$message.success('重命名成功');
                        } else {
                            throw new Error('重命名失败');
                        }
                    } catch (error) {
                        console.error('重命名失败:', error);
                        this.$message.error('重命名失败');
                    } finally {
                        this.renameDialog.loading = false;
                    }
                },

                // 删除文件
                deleteFile(file) {
                    this.$confirm(`确定要删除文件 "${file.metadata.fileName}" 吗？`, '确认删除', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(async () => {
                        try {
                            const response = await fetch(`/api/finder/delete/${file.name}`, {
                                method: 'DELETE',
                                credentials: 'include'
                            });

                            if (response.ok) {
                                const index = this.files.findIndex(f => f.name === file.name);
                                if (index > -1) {
                                    this.files.splice(index, 1);
                                    this.filterFiles();
                                }
                                this.$message.success('删除成功');
                            } else {
                                throw new Error('删除失败');
                            }
                        } catch (error) {
                            console.error('删除文件失败:', error);
                            this.$message.error('删除失败');
                        }
                    }).catch(() => {
                        // 用户取消删除
                    });
                },

                // 处理图片加载错误
                handleImageError(event) {
                    event.target.style.display = 'none';
                    const icon = document.createElement('i');
                    icon.className = 'el-icon-picture file-icon';
                    event.target.parentNode.appendChild(icon);
                },

                // 返回管理页面
                goBack() {
                    window.location.href = '/admin.html';
                },

                // 重定向到登录
                redirectToLogin() {
                    window.location.href = '/api/manage/login';
                }
            }
        });
    </script>
</body>
</html>
